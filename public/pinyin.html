<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Â£∞ÊØçÈüµÊØç - ÊãºÈü≥Â≠¶‰π†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #fff3e0;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 16px;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
      margin-bottom: 12px;
      border-bottom: 2px solid #ff6f61;
      padding-bottom: 8px;
    }

    .pinyin-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }

    .pinyin-btn {
      background: white;
      border: 2px solid #ff6f61;
      border-radius: 8px;
      padding: 10px 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-height: 80px;
      font-family: inherit;
    }

    .pinyin-btn:hover {
      background: #ffe0d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .pinyin-btn:active {
      transform: scale(0.95);
    }

    .pinyin-text {
      font-size: 16px;
      font-weight: bold;
      color: #ff6f61;
    }

    .learn-count {
      font-size: 11px;
      color: #999;
      background: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .empty-message {
      text-align: center;
      color: #888;
      padding: 40px 16px;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .pinyin-list {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .pinyin-btn {
        min-height: 70px;
        padding: 8px 6px;
      }
      
      .pinyin-text {
        font-size: 14px;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      .pinyin-list {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (min-width: 769px) {
      .pinyin-list {
        grid-template-columns: repeat(5, 1fr);
      }
    }
  </style>
</head>

<body>
<div class="container">
  <div id="initialsSection"></div>
  <div id="finalsSection"></div>
</div>

<script>
// ‰ªéÁà∂È°µÈù¢Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

// Â£∞ÊØç
const initials = [
  "b", "p", "m", "f", "d", "t", "n", "l", "g", "k", "h",
  "j", "q", "x", "zh", "ch", "sh", "r", "z", "c", "s", "y", "w"
];

// ÈüµÊØç
const finals = [
  "a", "o", "e", "i", "u", "√º", "er",
  "ai", "ei", "ao", "ou", "an", "en", "ang", "eng", "ong",
  "ia", "ie", "iao", "iu", "ian", "in", "iang", "ing", "iong",
  "ua", "uo", "uai", "ui", "uan", "un", "uang", "ueng",
  "√ºe", "√ºan", "√ºn"
];

// ÊãºÈü≥ÂØπÂ∫îÁöÑÁ§∫‰æãÊ±âÂ≠óÔºàÁî®‰∫éÂèëÈü≥Ôºâ
const pinyinExamples = {
  // Â£∞ÊØç‰æãÂ≠ê
  'b': 'ÂÖ´',
  'p': 'Ê≥°',
  'm': 'Â¶à',
  'f': '‰Ωõ',
  'd': 'Â§ß',
  't': '‰ªñ',
  'n': '‰Ω†',
  'l': 'Êù•',
  'g': 'Âì•',
  'k': 'Âç°',
  'h': 'Âëµ',
  'j': 'È∏°',
  'q': '‰∏É',
  'x': 'Ë•ø',
  'zh': 'Áü•',
  'ch': 'ÂêÉ',
  'sh': 'ËØó',
  'r': 'Êó•',
  'z': 'Â≠ê',
  'c': 'Ê¨°',
  's': 'ÊÄù',
  'y': 'ÁÉü',
  'w': '‰∫î',
  // ÈüµÊØç‰æãÂ≠ê
  'a': 'Âïä',
  'o': 'Âì¶',
  'e': 'ÂëÉ',
  'i': 'Ë°£',
  'u': '‰πå',
  '√º': 'Â•≥',
  'er': 'ÂÑø',
  'ai': 'Áà±',
  'ei': 'Ê¨∏',
  'ao': 'ÁÜ¨',
  'ou': 'Ê¨ß',
  'an': 'ÂÆâ',
  'en': 'ÊÅ©',
  'ang': 'ÊòÇ',
  'eng': 'ÂóØ',
  'ong': 'Âó°',
  'ia': 'ÂëÄ',
  'ie': 'ËÄ∂',
  'iao': 'ËÖ∞',
  'iu': 'Ê≤π',
  'ian': 'ÁÉü',
  'in': 'Âõ†',
  'iang': 'Â§Æ',
  'ing': 'Ëã±',
  'iong': 'Áî®',
  'ua': 'Ëõô',
  'uo': 'Êàë',
  'uai': 'Ê≠™',
  'ui': 'Â®Å',
  'uan': 'ÂºØ',
  'un': 'Ê∏©',
  'uang': 'Áéã',
  'ueng': 'ÁøÅ',
  '√ºe': 'Á∫¶',
  '√ºan': 'ÂÜ§',
  '√ºn': 'Êôï'
};

function speakPinyin(py, type) {
  // ‰ΩøÁî®Ê±âÂ≠óÁ§∫‰æãÊù•ÂèëÈü≥Ôºå‰ª•Ëé∑ÂæóÊõ¥ÂáÜÁ°ÆÁöÑÂèëÈü≥
  const example = pinyinExamples[py];
  if (!example) return;
  
  // Ë∞ÉÁî®Áà∂È°µÈù¢ÁöÑÁªü‰∏ÄÂèëÈü≥ÂáΩÊï∞
  if (window.parent && window.parent.speak) {
    window.parent.speak(example, 'pinyin');
  } else {
    // Â§áÁî®ÊñπÊ°àÔºàÂ¶ÇÊûúÂú®Áã¨Á´ãÁéØÂ¢É‰∏≠Ôºâ
    const u = new SpeechSynthesisUtterance(example);
    u.lang = "zh-CN";
    u.rate = 0.8;
    u.pitch = 1;
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(u);
    }, 50);
  }
}

function createPinyinButton(py, type, learnCount) {
  const btn = document.createElement("button");
  btn.className = "pinyin-btn";
  btn.innerHTML = `
    <span class="pinyin-text">${py}</span>
    <span class="learn-count">üîä ${learnCount || 0}</span>
  `;
  
  btn.onclick = (e) => {
    e.stopPropagation();
    speakPinyin(py, type);
    recordLearn(py, type);
    
    // Êõ¥Êñ∞Â≠¶‰π†ËÆ°Êï∞
    const countSpan = btn.querySelector(".learn-count");
    const currentCount = parseInt(countSpan.textContent.match(/\d+/)[0]);
    countSpan.textContent = `üîä ${currentCount + 1}`;
  };
  
  return btn;
}

function recordLearn(py, type) {
  if (!currentUser) return;
  
  fetch("/api/pinyin-learn", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      user_id: currentUser.user_id, 
      pinyin: py, 
      type: type 
    })
  }).catch(err => console.error("ËÆ∞ÂΩïÂ§±Ë¥•Ôºö", err));
}

function loadPinyinPage() {
  if (!currentUser) return;

  // ÂÖàËé∑ÂèñÁî®Êà∑ÁöÑÂ≠¶‰π†ËÆ∞ÂΩï
  fetch(`/api/pinyin/${currentUser.user_id}`)
    .then(res => res.json())
    .then(data => {
      // ÊûÑÂª∫Â≠¶‰π†ËÆ∞ÂΩïÊò†Â∞Ñ
      const learnMap = {};
      data.forEach(item => {
        learnMap[`${item.type}:${item.pinyin}`] = item.learn_count || 0;
      });

      // Â¶ÇÊûúÁî®Êà∑Ê≤°Êúâ‰ªª‰ΩïËÆ∞ÂΩïÔºåÂàùÂßãÂåñ
      if (data.length === 0) {
        fetch("/api/pinyin-init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: currentUser.user_id })
        }).then(() => loadPinyinPage());
        return;
      }

      // Ê∏≤ÊüìÂ£∞ÊØç
      const initialsSection = document.getElementById("initialsSection");
      initialsSection.innerHTML = '<div class="section-title">Â£∞ÊØç</div>';
      const initialsList = document.createElement("div");
      initialsList.className = "pinyin-list";
      
      initials.forEach(py => {
        const count = learnMap[`initial:${py}`] || 0;
        initialsList.appendChild(createPinyinButton(py, "initial", count));
      });
      
      initialsSection.appendChild(initialsList);

      // Ê∏≤ÊüìÈüµÊØç
      const finalsSection = document.getElementById("finalsSection");
      finalsSection.innerHTML = '<div class="section-title">ÈüµÊØç</div>';
      const finalsList = document.createElement("div");
      finalsList.className = "pinyin-list";
      
      finals.forEach(py => {
        const count = learnMap[`final:${py}`] || 0;
        finalsList.appendChild(createPinyinButton(py, "final", count));
      });
      
      finalsSection.appendChild(finalsList);
    })
    .catch(err => {
      console.error("Âä†ËΩΩÂ§±Ë¥•Ôºö", err);
      document.getElementById("initialsSection").innerHTML = 
        '<div class="empty-message">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>';
    });
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
loadPinyinPage();
</script>
</body>
</html>
