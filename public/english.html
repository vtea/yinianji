<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ëã±ËØ≠ - ËØçÊ±áÂ≠¶‰π†</title>
  <style>
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
    }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
      background: #ffffff;
      color: var(--text-color);
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    .level-selector {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
      background: #f7f7f7;
      padding: 12px;
      border-radius: 24px;
    }

    .level-btn {
      padding: 12px 24px;
      border: 2px solid transparent;
      background: transparent;
      border-radius: 16px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 800;
      color: #afafaf;
      transition: all 0.2s;
    }

    .level-btn:hover {
      color: var(--text-color);
    }

    .level-btn.active {
      background: white;
      color: var(--secondary-color);
      box-shadow: 0 4px 0 var(--border-color);
      transform: translateY(4px);
    }


    .vocab-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 0 #e5a500;
      transition: all 0.1s;
    }

    .vocab-btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0;
    }

    .section-title {
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      margin: 40px 0 24px;
      color: var(--text-color);
    }

    .word-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 24px;
    }

    .word-card {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      padding: 24px 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      box-shadow: 0 4px 0 var(--border-color);
    }

    .word-card:hover {
      background-color: #f7f7f7;
      transform: translateY(-2px);
    }

    .word-card:active {
      transform: translateY(2px);
      box-shadow: 0 0px 0 var(--border-color);
    }

    .word-card.learned {
      border-color: var(--primary-color);
      background: #f7fff0;
      box-shadow: 0 4px 0 var(--primary-color);
    }

    .word-english {
      font-size: 22px;
      font-weight: 800;
      color: var(--secondary-color);
    }

    .word-phonetic {
      font-size: 14px;
      color: #afafaf;
      font-weight: 500;
    }

    .word-chinese {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-color);
      background: #f1f1f1;
      padding: 4px 12px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .word-card:hover .word-chinese,
    .word-card.learned .word-chinese {
      opacity: 1;
    }

    .add-vocab-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-vocab-btn.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
      box-shadow: 0 2px 0 #e5a500;
    }

    .learn-count {
      font-size: 12px;
      font-weight: 800;
      color: #afafaf;
    }

    .empty-message {
      text-align: center;
      color: #afafaf;
      padding: 60px 16px;
      font-size: 18px;
      font-weight: 800;
    }

    @media (max-width: 480px) {
      .word-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="level-selector" id="levelSelector"></div>
  <div id="contentArea"></div>
</div>

<script>
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
let userVocab = new Set();
let currentLevel = 'beginner';

// Ëã±ËØ≠ËØçÊ±áÂ∫ì
const englishVocabulary = {
  'beginner': {
    name: 'Â∞èÁôΩÂÖ•Èó®',
    words: [
      { english: 'hello', phonetic: '/h…ôÀàlo ä/', chinese: '‰Ω†Â•Ω' },
      { english: 'goodbye', phonetic: '/…° ädÀàba…™/', chinese: 'ÂÜçËßÅ' },
      { english: 'yes', phonetic: '/j…õs/', chinese: 'ÊòØÁöÑ' },
      { english: 'no', phonetic: '/no ä/', chinese: '‰∏çÊòØ' },
      { english: 'please', phonetic: '/pliÀêz/', chinese: 'ËØ∑' },
      { english: 'thank you', phonetic: '/Œ∏√¶≈ãk juÀê/', chinese: 'Ë∞¢Ë∞¢‰Ω†' },
      { english: 'sorry', phonetic: '/Ààs…ëÀêri/', chinese: 'ÂØπ‰∏çËµ∑' },
      { english: 'ok', phonetic: '/Àåo äÀàke…™/', chinese: 'Â•ΩÁöÑ' },
      { english: 'my', phonetic: '/ma…™/', chinese: 'ÊàëÁöÑ' },
      { english: 'you', phonetic: '/juÀê/', chinese: '‰Ω†' },
      { english: 'he', phonetic: '/hiÀê/', chinese: '‰ªñ' },
      { english: 'she', phonetic: '/ ÉiÀê/', chinese: 'Â•π' },
      { english: 'mom', phonetic: '/m…ëÀêm/', chinese: 'Â¶àÂ¶à' },
      { english: 'dad', phonetic: '/d√¶d/', chinese: 'Áà∏Áà∏' },
      { english: 'apple', phonetic: '/Àà√¶pl/', chinese: 'ËãπÊûú' },
      { english: 'cat', phonetic: '/k√¶t/', chinese: 'Áå´' },
      { english: 'dog', phonetic: '/d…îÀê…°/', chinese: 'Áãó' },
      { english: 'sun', phonetic: '/s ån/', chinese: 'Â§™Èò≥' },
      { english: 'moon', phonetic: '/muÀên/', chinese: 'Êúà‰∫Æ' },
      { english: 'water', phonetic: '/Ààw…îÀêt…ôr/', chinese: 'Ê∞¥' },
    ]
  },
  'grade1': {
    name: '1Âπ¥Á∫ß',
    words: [
      { english: 'book', phonetic: '/b äk/', chinese: '‰π¶' },
      { english: 'pen', phonetic: '/p…õn/', chinese: 'Á¨î' },
      { english: 'pencil', phonetic: '/Ààp…õnsl/', chinese: 'ÈìÖÁ¨î' },
      { english: 'table', phonetic: '/Ààte…™bl/', chinese: 'Ê°åÂ≠ê' },
      { english: 'chair', phonetic: '/t É…õr/', chinese: 'Ê§ÖÂ≠ê' },
      { english: 'room', phonetic: '/ruÀêm/', chinese: 'ÊàøÈó¥' },
      { english: 'school', phonetic: '/skuÀêl/', chinese: 'Â≠¶Ê†°' },
      { english: 'teacher', phonetic: '/ÀàtiÀêt É…ôr/', chinese: 'ËÄÅÂ∏à' },
      { english: 'student', phonetic: '/ÀàstuÀêd…ônt/', chinese: 'Â≠¶Áîü' },
      { english: 'friend', phonetic: '/fr…õnd/', chinese: 'ÊúãÂèã' },
      { english: 'red', phonetic: '/r…õd/', chinese: 'Á∫¢Ëâ≤' },
      { english: 'blue', phonetic: '/bluÀê/', chinese: 'ËìùËâ≤' },
      { english: 'green', phonetic: '/…°riÀên/', chinese: 'ÁªøËâ≤' },
      { english: 'yellow', phonetic: '/Ààj…õlo ä/', chinese: 'ÈªÑËâ≤' },
      { english: 'big', phonetic: '/b…™…°/', chinese: 'Â§ßÁöÑ' },
      { english: 'small', phonetic: '/sm…îÀêl/', chinese: 'Â∞èÁöÑ' },
      { english: 'one', phonetic: '/w ån/', chinese: '‰∏Ä' },
      { english: 'two', phonetic: '/tuÀê/', chinese: '‰∫å' },
      { english: 'three', phonetic: '/Œ∏riÀê/', chinese: '‰∏â' },
      { english: 'four', phonetic: '/f…îÀêr/', chinese: 'Âõõ' },
      { english: 'five', phonetic: '/fa…™v/', chinese: '‰∫î' },
      { english: 'good', phonetic: '/…° äd/', chinese: 'Â•ΩÁöÑ' },
      { english: 'bad', phonetic: '/b√¶d/', chinese: 'ÂùèÁöÑ' },
      { english: 'happy', phonetic: '/Ààh√¶pi/', chinese: 'Âø´‰πêÁöÑ' },
      { english: 'sad', phonetic: '/s√¶d/', chinese: '‰º§ÂøÉÁöÑ' },
    ]
  },
  'grade2': {
    name: '2Âπ¥Á∫ß',
    words: [
      { english: 'bread', phonetic: '/br…õd/', chinese: 'Èù¢ÂåÖ' },
      { english: 'milk', phonetic: '/m…™lk/', chinese: 'ÁâõÂ•∂' },
      { english: 'rice', phonetic: '/ra…™s/', chinese: 'Á±≥È•≠' },
      { english: 'chicken', phonetic: '/Ààt É…™k…ôn/', chinese: 'È∏°ËÇâ' },
      { english: 'fish', phonetic: '/f…™ É/', chinese: 'È±º' },
      { english: 'egg', phonetic: '/…õ…°/', chinese: 'È∏°Ëõã' },
      { english: 'orange', phonetic: '/Àà…îÀêr…™nd í/', chinese: 'Ê©ôÂ≠ê' },
      { english: 'banana', phonetic: '/b…ôÀàn√¶n…ô/', chinese: 'È¶ôËïâ' },
      { english: 'strawberry', phonetic: '/Ààstr…îÀêb…õri/', chinese: 'ËçâËéì' },
      { english: 'flower', phonetic: '/Ààfla ä…ôr/', chinese: 'Ëä±' },
      { english: 'tree', phonetic: '/triÀê/', chinese: 'Ê†ë' },
      { english: 'grass', phonetic: '/…°r√¶s/', chinese: 'Ëçâ' },
      { english: 'sky', phonetic: '/ska…™/', chinese: 'Â§©Á©∫' },
      { english: 'rain', phonetic: '/re…™n/', chinese: 'Èõ®' },
      { english: 'snow', phonetic: '/sno ä/', chinese: 'Èõ™' },
      { english: 'wind', phonetic: '/w…™nd/', chinese: 'È£é' },
      { english: 'cloud', phonetic: '/kla äd/', chinese: '‰∫ë' },
      { english: 'star', phonetic: '/st…ëÀêr/', chinese: 'ÊòüÊòü' },
      { english: 'bird', phonetic: '/b…úÀêrd/', chinese: 'È∏ü' },
      { english: 'pig', phonetic: '/p…™…°/', chinese: 'Áå™' },
      { english: 'cow', phonetic: '/ka ä/', chinese: 'Áâõ' },
      { english: 'horse', phonetic: '/h…îÀêrs/', chinese: 'È©¨' },
      { english: 'run', phonetic: '/r ån/', chinese: 'Ë∑ë' },
      { english: 'walk', phonetic: '/w…îÀêk/', chinese: 'Ëµ∞' },
      { english: 'jump', phonetic: '/d í åmp/', chinese: 'Ë∑≥' },
    ]
  },
  'grade3': {
    name: '3Âπ¥Á∫ß',
    words: [
      { english: 'computer', phonetic: '/k…ômÀàpjuÀêt…ôr/', chinese: 'ÁîµËÑë' },
      { english: 'telephone', phonetic: '/Ààt…õl…™fo än/', chinese: 'ÁîµËØù' },
      { english: 'bicycle', phonetic: '/Ààba…™s…™kl/', chinese: 'Ëá™Ë°åËΩ¶' },
      { english: 'car', phonetic: '/k…ëÀêr/', chinese: 'Ê±ΩËΩ¶' },
      { english: 'bus', phonetic: '/b ås/', chinese: 'ÂÖ¨‰∫§ËΩ¶' },
      { english: 'train', phonetic: '/tre…™n/', chinese: 'ÁÅ´ËΩ¶' },
      { english: 'plane', phonetic: '/ple…™n/', chinese: 'È£ûÊú∫' },
      { english: 'ship', phonetic: '/ É…™p/', chinese: 'Ëàπ' },
      { english: 'road', phonetic: '/ro äd/', chinese: 'ÈÅìË∑Ø' },
      { english: 'bridge', phonetic: '/br…™d í/', chinese: 'Ê°•' },
      { english: 'building', phonetic: '/Ààb…™ld…™≈ã/', chinese: 'Âª∫Á≠ëÁâ©' },
      { english: 'hospital', phonetic: '/Ààh…ëÀêsp…™tl/', chinese: 'ÂåªÈô¢' },
      { english: 'library', phonetic: '/Ààla…™br…õri/', chinese: 'Âõæ‰π¶È¶Ü' },
      { english: 'restaurant', phonetic: '/Ààr…õst…ôr…ëÀênt/', chinese: 'È§êÂéÖ' },
      { english: 'market', phonetic: '/Ààm…ëÀêrk…™t/', chinese: 'Â∏ÇÂú∫' },
      { english: 'park', phonetic: '/p…ëÀêrk/', chinese: 'ÂÖ¨Âõ≠' },
      { english: 'beach', phonetic: '/biÀêt É/', chinese: 'Êµ∑Êª©' },
      { english: 'mountain', phonetic: '/Ààma änt…ôn/', chinese: 'Â±±' },
      { english: 'river', phonetic: '/Ààr…™v…ôr/', chinese: 'Ê≤≥' },
      { english: 'lake', phonetic: '/le…™k/', chinese: 'Êπñ' },
      { english: 'morning', phonetic: '/Ààm…îÀêrn…™≈ã/', chinese: 'Êó©‰∏ä' },
      { english: 'afternoon', phonetic: '/Àå√¶ft…ôrÀànuÀên/', chinese: '‰∏ãÂçà' },
      { english: 'night', phonetic: '/na…™t/', chinese: 'Êôö‰∏ä' },
      { english: 'winter', phonetic: '/Ààw…™nt…ôr/', chinese: 'ÂÜ¨Â§©' },
      { english: 'summer', phonetic: '/Ààs åm…ôr/', chinese: 'Â§èÂ§©' },
      { english: 'spring', phonetic: '/spr…™≈ã/', chinese: 'Êò•Â§©' },
      { english: 'autumn', phonetic: '/Àà…îÀêt…ôm/', chinese: 'ÁßãÂ§©' },
    ]
  }
};

async function loadUserVocab() {
  if (!currentUser) return;
  try {
    const res = await fetch(`/api/english-new-words/${currentUser.user_id}`);
    const words = await res.json();
    userVocab = new Set(words.map(w => w.word));
    renderLevel(currentLevel);
  } catch (err) {
    console.error("Âä†ËΩΩÂçïËØçÊú¨Â§±Ë¥•Ôºö", err);
  }
}

async function toggleVocab(event, wordObj) {
  event.stopPropagation();
  if (!currentUser) return alert("ËØ∑ÂÖàÁôªÂΩï");
  
  const isAdding = !userVocab.has(wordObj.english);
  const url = "/api/english-new-words";
  const method = isAdding ? "POST" : "DELETE";
  
  try {
    const res = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        user_id: currentUser.user_id, 
        word: wordObj.english,
        phonetic: wordObj.phonetic,
        chinese: wordObj.chinese
      })
    });
    
    if (res.ok) {
      if (isAdding) {
        userVocab.add(wordObj.english);
      } else {
        userVocab.delete(wordObj.english);
      }
      renderLevel(currentLevel);
    }
  } catch (err) {
    console.error("Êìç‰ΩúÂ§±Ë¥•Ôºö", err);
  }
}

function speakWord(english) {
  if (!english) return;
  if (window.parent && window.parent.speak) {
    window.parent.speak(english, 'english');
  } else {
    const saved = localStorage.getItem("voiceSettings");
    const voiceSettings = saved ? JSON.parse(saved) : { rate: 0.8 };
    const u = new SpeechSynthesisUtterance(english);
    u.lang = "en-US";
    u.rate = voiceSettings.rate;
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(u);
    }, 50);
  }

}

function recordLearn(english) {
  if (!currentUser) return;
  fetch("/api/english-learn", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      user_id: currentUser.user_id, 
      word: english,
      level: currentLevel
    })
  }).catch(err => console.error("ËÆ∞ÂΩïÂ§±Ë¥•Ôºö", err));
}

function createWordCard(wordObj, learnCount = 0) {
  const isInVocab = userVocab.has(wordObj.english);
  const card = document.createElement("div");
  card.className = "word-card" + (learnCount > 0 ? " learned" : "");
  card.innerHTML = `
    <button class="add-vocab-btn ${isInVocab ? 'active' : ''}" onclick="toggleVocab(event, ${JSON.stringify(wordObj).replace(/"/g, '&quot;')})">üìñ</button>
    <div class="word-english">${wordObj.english}</div>
    <div class="word-phonetic">${wordObj.phonetic || ''}</div>
    <div class="word-chinese">${wordObj.chinese || ''}</div>
    <div class="learn-count">üîä ${learnCount}</div>
  `;
  
  card.onclick = () => {
    speakWord(wordObj.english);
    recordLearn(wordObj.english);
    card.classList.add("learned");
    const countEl = card.querySelector(".learn-count");
    const count = parseInt(countEl.textContent.match(/\d+/)[0]);
    countEl.textContent = `üîä ${count + 1}`;
  };
  
  return card;
}

function renderLevel(level) {
  currentLevel = level;
  const data = englishVocabulary[level];
  const contentArea = document.getElementById("contentArea");
  
  contentArea.innerHTML = `
    <div class="section-title">${data.name}</div>
    <div class="word-list" id="wordList"></div>
  `;
  
  const wordList = document.getElementById("wordList");
  data.words.forEach(word => {
    wordList.appendChild(createWordCard(word, 0));
  });

  fetchMissingPhonetics();
}

async function fetchMissingPhonetics() {
  const cards = document.querySelectorAll(".word-card");
  for (const card of cards) {
    const phoneticEl = card.querySelector(".word-phonetic");
    const english = card.querySelector(".word-english").textContent;
    
    if (!phoneticEl.textContent || phoneticEl.textContent === "undefined") {
      try {
        const res = await fetch(`/api/proxy/english/${english}`);
        const data = await res.json();
        if (data.phonetic) {
          phoneticEl.textContent = data.phonetic;
        }
      } catch (err) {
        console.error(`Ëé∑Âèñ ${english} Èü≥Ê†áÂ§±Ë¥•`, err);
      }
    }
  }
}

function initLevelSelector() {
  const selector = document.getElementById("levelSelector");
  selector.innerHTML = '';
  Object.keys(englishVocabulary).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "level-btn" + (key === currentLevel ? " active" : "");
    btn.textContent = englishVocabulary[key].name;
    btn.onclick = () => {
      currentLevel = key;
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderLevel(key);
    };
    selector.appendChild(btn);
  });

  const vocabBtn = document.createElement("button");
  vocabBtn.className = "vocab-btn";
  vocabBtn.textContent = "üìñ ÂçïËØçÊú¨";
  vocabBtn.onclick = () => window.location.href = "vocabulary.html";
  selector.appendChild(vocabBtn);
}

// ÂàùÂßãÂåñ
if (currentUser) {
  loadUserVocab();
  initLevelSelector();
  renderLevel('beginner');
} else {
  document.getElementById("contentArea").innerHTML = '<div class="empty-message">ËØ∑ÂÖàÁôªÂΩï</div>';
}
</script>
</body>
</html>
