<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>ä¸€å¹´çº§å­¦ä¹ æœ¬ - Duolingo Style</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --primary-color: #58cc02;
    --primary-hover: #46a302;
    --secondary-color: #1cb0f6;
    --accent-color: #ffc800;
    --text-color: #4b4b4b;
    --border-color: #e5e5e5;
    --bg-color: #ffffff;
  }

  body {
    font-family: "din-round", "Microsoft YaHei", sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    padding: 0;
    margin: 0;
    overflow-x: hidden;
  }

  /* å¯¼èˆªæ  */
  .navbar {
    background: white;
    color: var(--text-color);
    padding: 0 24px;
    height: 70px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .navbar h1 {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary-color);
    margin: 0;
    letter-spacing: -0.5px;
  }

  .navbar-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* ç§»åŠ¨ç«¯ä¸‹æ‹‰èœå•ï¼šé»˜è®¤åœ¨æ¡Œé¢éšè— */
  .mobile-menu-btn { display: none; }
  .mobile-menu-backdrop { display: none; }
  .mobile-menu-sheet { display: none; }


  /* å¸ƒå±€ */
  .main-layout {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    min-height: calc(100vh - 72px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sidebar {
    width: 240px;
    padding: 24px 16px;
    border-right: 2px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s;
    position: relative;
    background: white;
  }

  .sidebar.collapsed {
    width: 80px;
    padding: 24px 8px;
  }

  /* åˆ†ç»„æ ·å¼ */
  .nav-group {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .nav-group-title {
    font-size: 11px;
    font-weight: 800;
    color: #afafaf;
    padding: 8px 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
  }

  .sidebar.collapsed .nav-group-title {
    opacity: 0;
    height: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
  }

  .sub-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding-left: 12px;
    border-left: 2px solid #f1f1f1;
    margin-left: 12px;
    transition: all 0.3s;
  }

  .sidebar.collapsed .sub-nav {
    padding-left: 0;
    border-left: none;
    margin-left: 0;
  }

  .sidebar.collapsed .nav-item {
    justify-content: center;
    padding: 14px 0;
    gap: 0;
  }

  .sidebar.collapsed .nav-item .nav-text {
    display: none;
  }

  .sidebar.collapsed .nav-item span {
    font-size: 24px;
    margin: 0;
  }

  .sidebar-toggle {
    position: absolute;
    right: -15px;
    top: 24px;
    width: 30px;
    height: 30px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 12px;
    font-weight: 800;
    color: #afafaf;
    transition: all 0.2s;
  }

  .sidebar-toggle:hover {
    color: var(--secondary-color);
    border-color: var(--secondary-color);
  }

  .nav-item {
    padding: 14px 16px;
    border-radius: 16px;
    cursor: pointer;
    font-weight: 800;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    color: #777;
    border: 2px solid transparent;
    transition: all 0.2s;
    text-transform: uppercase;
    white-space: nowrap;
    overflow: hidden;
  }


  .nav-item:hover {
    background-color: #f7f7f7;
    color: var(--text-color);
  }

  .nav-item.active {
    background-color: #ddf4ff;
    border-color: #84d8ff;
    color: #1899d6;
  }

  .content-area {
    flex: 1;
    background: #ffffff;
    padding: 0;
    overflow: hidden;
  }

  #contentFrame {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* ç”¨æˆ·èœå• */
  .user-menu-btn {
    padding: 8px 16px;
    border-radius: 12px;
    border: 2px solid var(--border-color);
    background: white;
    font-weight: 800;
    cursor: pointer;
    color: var(--text-color);
    box-shadow: 0 2px 0 var(--border-color);
  }

  .user-menu {
    display: none;
    position: absolute;
    top: 50px;
    right: 0;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    min-width: 200px;
    padding: 8px 0;
  }

  .user-menu.show { display: block; }

  .user-info-item {
    padding: 16px;
    border-bottom: 2px solid var(--border-color);
    font-weight: 800;
    color: var(--text-color);
  }

  .user-menu-item {
    padding: 12px 16px;
    cursor: pointer;
    font-weight: 700;
    color: #777;
  }

  .user-menu-item:hover { background: #f7f7f7; color: var(--text-color); }

  /* ç™»å½•æ³¨å†Œ */
  #auth-page {
    display: none;
    position: fixed;
    inset: 0;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: #f7f7f7;
    z-index: 2000;
    overflow: auto;
  }


  .auth-container {
    max-width: 400px;
    width: 100%;
    text-align: center;
  }

  .auth-panel {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 24px;
    padding: 28px 24px;
    box-shadow: 0 6px 0 var(--border-color);
  }

  .auth-panel h2 {
    font-size: 32px;
    font-weight: 800;
    margin: 0 0 24px;
  }

  .auth-toggle {
    margin-top: 16px;
    font-weight: 700;
    color: #777;
  }

  .auth-toggle a {
    color: var(--secondary-color);
    font-weight: 800;
    cursor: pointer;
    text-decoration: none;
  }


  .form-group input {
    width: 100%;
    padding: 16px;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    background: #f7f7f7;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 12px;
    box-sizing: border-box;
  }

  .auth-submit-btn {
    width: 100%;
    padding: 16px;
    border-radius: 16px;
    border: none;
    background: var(--secondary-color);
    color: white;
    font-weight: 800;
    font-size: 17px;
    box-shadow: 0 4px 0 #1899d6;
    cursor: pointer;
    margin-top: 12px;
    text-transform: uppercase;
  }

  .auth-submit-btn:active { transform: translateY(4px); box-shadow: 0 0 0; }

  .auth-error {
    color: #ff4b4b;
    font-weight: 700;
    margin-bottom: 16px;
    display: none;
  }

  /* æµ®åŠ¨æŒ‰é’® */
  .fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 64px;
    height: 64px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 32px;
    cursor: pointer;
    box-shadow: 0 6px 0 var(--primary-hover);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: all 0.1s;
  }

  .fab:active { transform: translateY(4px); box-shadow: 0 0 0; }

  /* æ¨¡æ€æ¡† */
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal.show { display: flex; }

  .modal-content {
    background: white;
    padding: 32px;
    border-radius: 24px;
    width: 90%;
    max-width: 450px;
    position: relative;
    box-shadow: 0 12px 0 rgba(0,0,0,0.1);
    border: 2px solid var(--border-color);
  }

  /* è®¾ç½®é¡¹æ ·å¼ */
  .setting-group {
    margin-bottom: 24px;
    text-align: left;
  }

  .setting-label {
    display: block;
    font-weight: 800;
    font-size: 16px;
    margin-bottom: 12px;
    color: var(--text-color);
  }

  .setting-select {
    width: 100%;
    padding: 14px;
    border-radius: 16px;
    border: 2px solid var(--border-color);
    background: #f7f7f7;
    font-size: 16px;
    font-weight: 700;
    color: var(--text-color);
    cursor: pointer;
    appearance: none;
  }

  .setting-range {
    width: 100%;
    margin-top: 8px;
    cursor: pointer;
  }


  /* ç§»åŠ¨ç«¯ï¼šå¯¼èˆªé»˜è®¤éšè—ï¼Œæ”¹ä¸ºä¸‹æ‹‰èœå•å±•ç¤º */
  @media (max-width: 768px) {
    html, body { height: 100%; overflow: hidden; }

    .navbar { height: 60px !important; padding: 0 12px !important; }
    .navbar h1 { font-size: 18px !important; flex-shrink: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }

    /* ç™»å½•é¡µï¼šç‹¬ç«‹æ»šåŠ¨ï¼Œé¿å…é”®ç›˜é¡¶èµ·åçœ‹ä¸åˆ°è¾“å…¥æ¡† */
    #auth-page {
      height: 100dvh;
      min-height: 100dvh;
      overflow-y: auto;
      padding: 18px 14px;
      display: none;
      align-items: flex-start; /* æ”¹ä¸º flex-start é…åˆ padding-top å±…ä¸­ï¼Œé¿å…å†…å®¹å¤šæ—¶ä¸Šæ–¹è¢«è£åˆ‡ */
      justify-content: center;
    }
    #auth-page.show-flex { display: flex; }
    .auth-container { margin-top: auto; margin-bottom: auto; padding: 20px 0; }

    .auth-panel {
      padding: 22px 18px;
      border-radius: 22px;
    }
    .auth-panel h2 { font-size: 26px; }


    .navbar-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .user-menu-btn { padding: 6px 10px; font-size: 14px; }
    .mobile-menu-btn { display: inline-flex !important; }

    /* ä¸»å†…å®¹åªç•™ç»™ iframeï¼Œä¸è¦æ•´é¡µæ»šåŠ¨ */
    .main-layout {
      height: calc(100dvh - 60px) !important;
      width: 100% !important;
      display: block !important;
      min-height: 0 !important;
      margin: 0 !important;
      transition: none !important; /* ç§»åŠ¨ç«¯ç¦ç”¨è¿‡åº¦åŠ¨ç”»ï¼Œé˜²æ­¢å¸ƒå±€è·³åŠ¨ */
    }


    /* éšè—åŸä¾§è¾¹æ /åº•éƒ¨æ  */
    .sidebar, .sidebar.collapsed { display: none !important; }

    .content-area { height: 100% !important; width: 100% !important; }

    .mobile-menu-backdrop {
      position: fixed;
      top: 0; /* æ”¹ä¸ºå…¨å±ï¼Œz-index ä½äº sheet */
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1490;
      display: none;
      backdrop-filter: blur(2px);
    }
    .mobile-menu-backdrop.show { display: block; }

    .mobile-menu-sheet {
      display: block;
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 2px solid var(--border-color);
      z-index: 1500;
      transform: translateY(-110%);
      visibility: hidden; /* éšè—æ—¶ä¸å¯è§ä¸”ä¸å“åº”äº‹ä»¶ */
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.25s;
      padding: 8px 12px 20px;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .mobile-menu-sheet.show { transform: translateY(0); visibility: visible; }

    .mobile-menu-handle {
      width: 40px;
      height: 4px;
      border-radius: 99px;
      background: #eee;
      margin: 0 auto 12px;
    }

    .mobile-menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .mobile-menu-item {
      appearance: none;
      border: 2px solid var(--border-color);
      background: #fff;
      border-radius: 18px;
      padding: 12px 4px;
      font-weight: 800;
      color: #777;
      box-shadow: 0 4px 0 var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 80px;
      transition: all 0.1s;
    }
    .mobile-menu-item:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--border-color); }

    .mobile-menu-item .icon { font-size: 26px; line-height: 1; }
    .mobile-menu-item .label { font-size: 13px; font-weight: 800; }

    .mobile-menu-item.active {
      border-color: #84d8ff;
      color: #1899d6;
      background: #ddf4ff;
      box-shadow: 0 4px 0 #84d8ff;
    }

  }





</style>
</head>

<body>
  <div class="navbar" id="topNavbar">
    <h1>ğŸ¦‰ å­¦ä¹ æœ¬</h1>
    <div class="navbar-actions">
      <button class="user-menu-btn mobile-menu-btn" onclick="toggleMobileMenu()" id="mobileMenuBtn">â˜° èœå•</button>
      <div style="position: relative;">
        <button class="user-menu-btn" onclick="toggleUserMenu()" id="userMenuBtn">ğŸ‘¤ è´¦æˆ·</button>
        <div class="user-menu" id="userMenu">
          <div class="user-info-item" id="usernameDisplay"></div>
          <div class="user-menu-item" onclick="openPronunciationSettings()">ğŸ”Š å‘éŸ³è®¾ç½®</div>
          <div class="user-menu-item" onclick="openChangePasswordModal()">ğŸ”‘ ä¿®æ”¹å¯†ç </div>
          <div class="user-menu-item" onclick="logout()" style="color: #ff4b4b; border-top: 2px solid var(--border-color);">ğŸšª é€€å‡ºç™»å½•</div>
        </div>

      </div>
    </div>
  </div>

  <div class="mobile-menu-backdrop" id="mobileMenuBackdrop" onclick="closeMobileMenu()"></div>
  <div class="mobile-menu-sheet" id="mobileMenuSheet">
    <div class="mobile-menu-handle"></div>
    <div class="mobile-menu-grid">
      <button class="mobile-menu-item" data-page="chinese" onclick="switchPage('chinese'); closeMobileMenu();"><div class="icon">ğŸ“š</div><div class="label">ç”Ÿå­—æœ¬</div></button>
      <button class="mobile-menu-item" data-page="pinyin" onclick="switchPage('pinyin'); closeMobileMenu();"><div class="icon">ğŸ”¤</div><div class="label">æ‹¼éŸ³</div></button>
      <button class="mobile-menu-item" data-page="english" onclick="switchPage('english'); closeMobileMenu();"><div class="icon">ğŸŒ</div><div class="label">è‹±è¯­è¯¾æ–‡</div></button>
      <button class="mobile-menu-item" data-page="vocabulary" onclick="switchPage('vocabulary'); closeMobileMenu();"><div class="icon">ğŸ“–</div><div class="label">å•è¯æœ¬</div></button>
      <button class="mobile-menu-item" data-page="ai-tutor" onclick="switchPage('ai-tutor'); closeMobileMenu();"><div class="icon">ğŸ¤–</div><div class="label">AI è¾…å¯¼</div></button>
      <button class="mobile-menu-item" data-page="math" onclick="switchPage('math'); closeMobileMenu();"><div class="icon">ğŸ”¢</div><div class="label">æ•°å­¦ç»ƒä¹ </div></button>
    </div>
  </div>


  <div class="main-layout" id="app-page">
    <div class="sidebar collapsed" id="featureNav">
      <div class="sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle">â¯</div>
      
      <!-- è¯­æ–‡åˆ†ç»„ -->
      <div class="nav-group">
        <div class="nav-group-title">è¯­æ–‡</div>
        <div class="nav-item active" onclick="switchPage('chinese')"><span>ğŸ“š</span> <span class="nav-text">ç”Ÿå­—æœ¬</span></div>
        <div class="sub-nav">
          <div class="nav-item" onclick="switchPage('pinyin')"><span>ğŸ”¤</span> <span class="nav-text">æ‹¼éŸ³</span></div>
        </div>
      </div>

      <!-- è‹±è¯­åˆ†ç»„ -->
      <div class="nav-group">
        <div class="nav-group-title">è‹±è¯­</div>
        <div class="nav-item" onclick="switchPage('english')"><span>ğŸŒ</span> <span class="nav-text">è‹±è¯­è¯¾æ–‡</span></div>
        <div class="sub-nav">
          <div class="nav-item" onclick="switchPage('vocabulary')"><span>ğŸ“–</span> <span class="nav-text">å•è¯æœ¬</span></div>
        </div>
      </div>

      <!-- å…¶ä»– -->
      <div class="nav-group">
        <div class="nav-group-title">å·¥å…·</div>
        <div class="nav-item" onclick="switchPage('ai-tutor')"><span>ğŸ¤–</span> <span class="nav-text">AI è¾…å¯¼</span></div>
        <div class="nav-item" onclick="switchPage('math')"><span>ğŸ”¢</span> <span class="nav-text">æ•°å­¦ç»ƒä¹ </span></div>
      </div>
    </div>


    <div class="content-area">
      <iframe id="contentFrame" src="chinese.html"></iframe>
    </div>
  </div>

  <div id="auth-page">
    <div class="auth-container">
      <div class="auth-panel active" id="login-panel">
        <h2>ç™»å½•å­¦ä¹ </h2>
        <div class="auth-error" id="login-error"></div>
        <form onsubmit="handleLogin(event)">
          <div class="form-group"><input type="text" id="login-username" placeholder="ç”¨æˆ·å" required /></div>
          <div class="form-group"><input type="password" id="login-password" placeholder="å¯†ç " required /></div>
          <button type="submit" class="auth-submit-btn">å¼€å§‹å­¦ä¹ </button>
        </form>
        <div class="auth-toggle">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a onclick="switchAuthMode()">ç«‹å³æ³¨å†Œ</a></div>
      </div>
      <div class="auth-panel" id="register-panel" style="display:none;">
        <h2>åˆ›å»ºè´¦å·</h2>
        <div class="auth-error" id="register-error"></div>
        <form onsubmit="handleRegister(event)">
          <div class="form-group"><input type="text" id="register-username" placeholder="ç”¨æˆ·å" required /></div>
          <div class="form-group"><input type="password" id="register-password" placeholder="å¯†ç " required /></div>
          <div class="form-group"><input type="password" id="register-confirm" placeholder="ç¡®è®¤å¯†ç " required /></div>
          <button type="submit" class="auth-submit-btn">æ³¨å†Œå¹¶ç™»å½•</button>
        </form>
        <div class="auth-toggle">å·²æœ‰è´¦å·ï¼Ÿ<a onclick="switchAuthMode()">è¿”å›ç™»å½•</a></div>
      </div>
    </div>
  </div>

  <button class="fab" onclick="openAddItemModal()" id="fabBtn">ï¼‹</button>

  <div class="modal" id="addItemModal" onclick="closeModal('addItemModal', event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 id="modalTitle" style="margin-top:0; font-size:24px; font-weight:800; color: var(--primary-color);">æ·»åŠ å†…å®¹</h3>
      <div id="modalInputArea"></div>
    </div>
  </div>

  <!-- å‘éŸ³è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="modal" id="settingsModal" onclick="closeModal('settingsModal', event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 style="margin-top:0; font-size:24px; font-weight:800; color: var(--secondary-color);">ğŸ”Š å‘éŸ³è®¾ç½®</h3>
      
      <div class="setting-group">
        <label class="setting-label">å‘éŸ³è¯­é€Ÿ</label>
        <input type="range" id="voiceRate" min="0.5" max="1.5" step="0.1" value="0.8" class="setting-range" onchange="updateVoiceSettings()">
        <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #aaa; margin-top: 4px;">
          <span>æ…¢</span>
          <span>æ­£å¸¸</span>
          <span>å¿«</span>
        </div>
      </div>

      <div class="setting-group">
        <label class="setting-label">é¦–é€‰å‘éŸ³è§’è‰²</label>
        <select id="voiceSelect" class="setting-select" onchange="updateVoiceSettings()">
          <option value="default">ç³»ç»Ÿé»˜è®¤</option>
        </select>
      </div>

      <button class="auth-submit-btn" onclick="closeModal('settingsModal')">å®Œæˆ</button>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
  <div class="modal" id="passwordModal" onclick="closeModal('passwordModal', event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 style="margin-top:0; font-size:24px; font-weight:800; color: var(--accent-color);">ğŸ”‘ ä¿®æ”¹å¯†ç </h3>
      <div class="form-group">
        <input type="password" id="old-password" placeholder="å½“å‰å¯†ç " required />
      </div>
      <div class="form-group">
        <input type="password" id="new-password" placeholder="æ–°å¯†ç " required />
      </div>
      <div class="form-group">
        <input type="password" id="confirm-password" placeholder="ç¡®è®¤æ–°å¯†ç " required />
      </div>
      <button class="auth-submit-btn" onclick="handleChangePassword()">æ›´æ–°å¯†ç </button>
    </div>
  </div>



<script>
let currentUser = null;
let currentPage = "chinese";

function restoreUser() {
  const saved = localStorage.getItem("currentUser");
  if (saved) {
    currentUser = JSON.parse(saved);
    showAppPage();
  } else {
    showAuthPage();
  }
}

function showAppPage() {
  document.getElementById("auth-page").classList.remove("show-flex");
  document.getElementById("app-page").style.display = "flex";
  document.getElementById("fabBtn").style.display = "flex";

  // ç™»å½•åæ˜¾ç¤ºé¡¶éƒ¨æ /ç§»åŠ¨ç«¯èœå•å…¥å£
  const navbar = document.getElementById("topNavbar");
  if (navbar) navbar.style.display = "flex";

  updateUserMenu();
  switchPage("chinese");
}

function showAuthPage() {
  document.getElementById("auth-page").classList.add("show-flex");
  document.getElementById("app-page").style.display = "none";
  document.getElementById("fabBtn").style.display = "none";

  // æœªç™»å½•æ—¶éšè—é¡¶éƒ¨æ /ç§»åŠ¨ç«¯èœå•ï¼Œé¿å…æŒ¡ä½ç™»å½•ç•Œé¢
  const navbar = document.getElementById("topNavbar");
  if (navbar) navbar.style.display = "none";
  closeMobileMenu();
}



function switchAuthMode() {
  const isLogin = document.getElementById("login-panel").style.display !== "none";
  document.getElementById("login-panel").style.display = isLogin ? "none" : "block";
  document.getElementById("register-panel").style.display = isLogin ? "block" : "none";
}

async function handleLogin(event) {
  event.preventDefault();
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;
  try {
    const res = await fetch("/api/login", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (res.ok) {
      currentUser = { user_id: data.user_id, username: data.username };
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
      showAppPage();
    } else { alert(data.error); }
  } catch (err) { alert("ç™»å½•å¤±è´¥"); }
}

async function handleRegister(event) {
  event.preventDefault();
  const username = document.getElementById("register-username").value;
  const password = document.getElementById("register-password").value;
  const confirm = document.getElementById("register-confirm").value;
  if (password !== confirm) return alert("å¯†ç ä¸ä¸€è‡´");
  try {
    const res = await fetch("/api/register", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });
    if (res.ok) { alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•"); switchAuthMode(); }
    else { const data = await res.json(); alert(data.error); }
  } catch (err) { alert("æ³¨å†Œå¤±è´¥"); }
}

function toggleSidebar() {
  const sidebar = document.getElementById("featureNav");
  const toggle = document.getElementById("sidebarToggle");
  const isCollapsed = sidebar.classList.toggle("collapsed");
  toggle.textContent = isCollapsed ? "â¯" : "â®";
  localStorage.setItem("sidebarCollapsed", isCollapsed);
}

// æ¢å¤ä¾§è¾¹æ çŠ¶æ€
function restoreSidebarState() {
    const sidebar = document.getElementById("featureNav");
    const toggle = document.getElementById("sidebarToggle");
    const saved = localStorage.getItem("sidebarCollapsed");
    if (saved === "false") {
        sidebar.classList.remove("collapsed");
        toggle.textContent = "â®";
    } else {
        sidebar.classList.add("collapsed");
        toggle.textContent = "â¯";
    }
}

function switchPage(page) {
  currentPage = page;
  localStorage.setItem("currentPage", page);
  const frameUrls = { 

    chinese: 'chinese.html', 
    pinyin: 'pinyin.html', 
    math: 'math.html', 
    english: 'english.html', 
    vocabulary: 'vocabulary.html',
    'ai-tutor': 'ai-tutor.html'
  };
  document.getElementById("contentFrame").src = frameUrls[page];
  
  // åˆ‡æ¢é¡µé¢æ—¶è‡ªåŠ¨å…³é—­ç”¨æˆ·èœå•/ç§»åŠ¨ç«¯èœå•
  document.getElementById("userMenu").classList.remove("show");
  closeMobileMenu();
  
  // å¤„ç†æ‚¬æµ®æŒ‰é’®çš„æ˜¾ç¤º/éšè—
  const fabBtn = document.getElementById("fabBtn");
  if (page === 'pinyin' || page === 'ai-tutor' || page === 'math') {
    fabBtn.style.display = "none";
  } else {
    fabBtn.style.display = "flex";
  }

  // æ¡Œé¢ä¾§è¾¹æ æ¿€æ´»æ€
  const navItems = document.querySelectorAll(".nav-item");
  navItems.forEach(item => {
    const navTextEl = item.querySelector('.nav-text');
    if (!navTextEl) return;
    const text = navTextEl.textContent;
    const match = (page==='chinese' && (text.includes('è¯­æ–‡') || text.includes('ç”Ÿå­—')))||
                  (page==='pinyin' && text.includes('æ‹¼éŸ³'))||
                  (page==='math' && text.includes('æ•°å­¦'))||
                  (page==='english' && text.includes('è‹±è¯­'))||
                  (page==='vocabulary' && text.includes('å•è¯æœ¬'))||
                  (page==='ai-tutor' && text.includes('AI'));
    item.classList.toggle("active", match);
  });

  // ç§»åŠ¨ç«¯ä¸‹æ‹‰èœå•æ¿€æ´»æ€
  document.querySelectorAll('.mobile-menu-item').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-page') === page);
  });
}


function openMobileMenu() {
  const sheet = document.getElementById('mobileMenuSheet');
  const backdrop = document.getElementById('mobileMenuBackdrop');
  if (!sheet || !backdrop) return;
  sheet.classList.add('show');
  backdrop.classList.add('show');
}

function closeMobileMenu() {
  const sheet = document.getElementById('mobileMenuSheet');
  const backdrop = document.getElementById('mobileMenuBackdrop');
  if (!sheet || !backdrop) return;
  sheet.classList.remove('show');
  backdrop.classList.remove('show');
}

function toggleMobileMenu() {
  const sheet = document.getElementById('mobileMenuSheet');
  if (!sheet) return;
  if (sheet.classList.contains('show')) closeMobileMenu();
  else openMobileMenu();
}

// ä»…ç§»åŠ¨ç«¯ï¼šåœ¨é¡¶éƒ¨æ æ”¯æŒä¸‹æ‹‰/ä¸Šæ»‘æ‰‹åŠ¿æ˜¾ç¤º/éšè—èœå•
(function initMobileMenuGesture() {
  const navbar = document.getElementById('topNavbar');
  if (!navbar) return;
  let startY = null;

  navbar.addEventListener('touchstart', (e) => {
    if (!e.touches || !e.touches[0]) return;
    startY = e.touches[0].clientY;
  }, { passive: true });

  navbar.addEventListener('touchmove', (e) => {
    if (startY == null) return;
    if (!e.touches || !e.touches[0]) return;
    const dy = e.touches[0].clientY - startY;
    // ä¸‹æ‹‰æ‰“å¼€
    if (dy > 35) {
      openMobileMenu();
      startY = null;
    }
    // ä¸Šæ»‘å…³é—­
    if (dy < -35) {
      closeMobileMenu();
      startY = null;
    }
  }, { passive: true });

  navbar.addEventListener('touchend', () => { startY = null; }, { passive: true });
})();

// ç‚¹å‡»å¤–éƒ¨å…³é—­ç”¨æˆ·èœå•/ç§»åŠ¨ç«¯èœå•
document.addEventListener('click', function(event) {
  const userMenu = document.getElementById("userMenu");
  const userMenuBtn = document.getElementById("userMenuBtn");
  if (userMenu && userMenuBtn && !userMenuBtn.contains(event.target) && !userMenu.contains(event.target)) {
    userMenu.classList.remove("show");
  }

  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileMenuSheet = document.getElementById('mobileMenuSheet');
  if (mobileMenuBtn && mobileMenuSheet && mobileMenuSheet.classList.contains('show')) {
    if (!mobileMenuBtn.contains(event.target) && !mobileMenuSheet.contains(event.target)) {
      closeMobileMenu();
    }
  }
});





function toggleUserMenu() { document.getElementById("userMenu").classList.toggle("show"); }
function updateUserMenu() { if(currentUser) document.getElementById("usernameDisplay").textContent = "ğŸ‘‹ ä½ å¥½, " + currentUser.username; }
function logout() { localStorage.removeItem("currentUser"); location.reload(); }

function openChangePasswordModal() {
  document.getElementById("passwordModal").classList.add("show");
  toggleUserMenu();
}

async function handleChangePassword() {
  const oldPassword = document.getElementById("old-password").value;
  const newPassword = document.getElementById("new-password").value;
  const confirmPassword = document.getElementById("confirm-password").value;

  if (!oldPassword || !newPassword || !confirmPassword) return alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
  if (newPassword !== confirmPassword) return alert("æ–°å¯†ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´");

  try {
    const res = await fetch("/api/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        user_id: currentUser.user_id,
        oldPassword,
        newPassword
      })
    });
    const data = await res.json();
    if (res.ok) {
      alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•");
      logout();
    } else {
      alert(data.error || "ä¿®æ”¹å¤±è´¥");
    }
  } catch (err) {
    alert("è¯·æ±‚å¤±è´¥");
  }
}


function openAddItemModal() {
  if (currentPage === 'pinyin') return;
  const area = document.getElementById("modalInputArea");
  const title = document.getElementById("modalTitle");
  if (currentPage === 'chinese') {
    title.textContent = "æ·»åŠ ç”Ÿå­—";
    area.innerHTML = '<div class="form-group"><input type="text" id="addItemInput" placeholder="è¯·è¾“å…¥ç”Ÿå­—" maxlength="1"></div><button class="auth-submit-btn" onclick="saveChineseItem()">ä¿å­˜</button>';
  } else if (currentPage === 'english' || currentPage === 'vocabulary') {
    title.textContent = "æ·»åŠ è‹±è¯­å•è¯";
    area.innerHTML = '<div class="form-group"><input type="text" id="addItemInput" placeholder="å•è¯" onblur="autoFetchEnglishInfo()"><input type="text" id="addItemInput2" placeholder="ç¿»è¯‘"><input type="text" id="addItemPhonetic" placeholder="éŸ³æ ‡"></div><button class="auth-submit-btn" onclick="saveEnglishItem()">ä¿å­˜</button>';
  }
  document.getElementById("addItemModal").classList.add("show");
}

function closeModal(modalId, e) {
  if(!e || e.target.id === modalId || !modalId.includes('event')) {
    const id = typeof modalId === 'string' ? modalId : (e ? e.target.id : '');
    if(id) document.getElementById(id).classList.remove("show");
    else if(!e) {
        // ç›´æ¥è°ƒç”¨å…³é—­
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    }
  }
}

// è¯­éŸ³è®¾ç½®é€»è¾‘
let voiceSettings = {
  rate: 0.8,
  voiceName: null
};

function initVoiceList() {
  const synth = window.speechSynthesis;
  const select = document.getElementById("voiceSelect");
  
  function populateVoices() {
    const voices = synth.getVoices();
    select.innerHTML = '<option value="default">ç³»ç»Ÿé»˜è®¤</option>';
    voices.forEach(voice => {
      if (voice.lang.includes('zh') || voice.lang.includes('en')) {
        const option = document.createElement('option');
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        select.appendChild(option);
      }
    });
    
    // æ¢å¤ä¿å­˜çš„è®¾ç½®
    const saved = localStorage.getItem("voiceSettings");
    if (saved) {
      voiceSettings = JSON.parse(saved);
      document.getElementById("voiceRate").value = voiceSettings.rate;
      document.getElementById("voiceSelect").value = voiceSettings.voiceName || 'default';
    }
  }

  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = populateVoices;
  }
  populateVoices();
}

function updateVoiceSettings() {
  voiceSettings.rate = parseFloat(document.getElementById("voiceRate").value);
  voiceSettings.voiceName = document.getElementById("voiceSelect").value;
  localStorage.setItem("voiceSettings", JSON.stringify(voiceSettings));
}

function openPronunciationSettings() {
  initVoiceList();
  document.getElementById("settingsModal").classList.add("show");
  document.getElementById("userMenu").classList.remove("show");
}


async function autoFetchEnglishInfo() {
  const word = document.getElementById("addItemInput").value.trim();
  if (!word) return;
  try {
    const res = await fetch(`/api/proxy/english/${word}`);
    const data = await res.json();
    if (data.chinese) document.getElementById("addItemInput2").value = data.chinese;
    if (data.phonetic) document.getElementById("addItemPhonetic").value = data.phonetic;
  } catch (e) {}
}

function saveChineseItem() {
  const hanzi = document.getElementById("addItemInput").value.trim();
  fetch("/api/words", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user_id: currentUser.user_id, hanzi })})
  .then(res => { if(res.ok) { closeModal('addItemModal'); document.getElementById("contentFrame").src = "chinese.html"; } });
}

function saveEnglishItem() {
  const word = document.getElementById("addItemInput").value.trim();
  const chinese = document.getElementById("addItemInput2").value.trim();
  const phonetic = document.getElementById("addItemPhonetic").value.trim();
  fetch("/api/english-new-words", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user_id: currentUser.user_id, word, chinese, phonetic })})
  .then(res => { if(res.ok) { closeModal('addItemModal'); document.getElementById("contentFrame").src = currentPage==='vocabulary'?'vocabulary.html':'english.html'; } });
}

// ç»Ÿä¸€å‘éŸ³ç³»ç»Ÿ (ç”± iframe è°ƒç”¨)
function speak(text, type) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = (type === 'english') ? "en-US" : "zh-CN";
  u.rate = voiceSettings.rate;
  
  if (voiceSettings.voiceName && voiceSettings.voiceName !== 'default') {
    const voices = window.speechSynthesis.getVoices();
    u.voice = voices.find(v => v.name === voiceSettings.voiceName);
  }

  speechSynthesis.cancel();
  setTimeout(() => speechSynthesis.speak(u), 50);
}


restoreUser();
restoreSidebarState();
</script>

</body>
</html>
