<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Âê¨Èü≥ÈÄâÂ≠óÊ∏∏Êàè - ÁîüÂ≠óÂ≠¶‰π†</title>
  <style>
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
      --error-color: #ff4b4b;
      --success-color: #58cc02;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
      background: #f7f7f7;
      color: var(--text-color);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      /* ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖçÔºåÈÅøÂÖçË¢´ÊµèËßàÂô®Ê†èÈÅÆÊå° */
      padding-bottom: env(safe-area-inset-bottom);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
    }

    .header {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary-color);
    }

    .score-info {
      display: flex;
      gap: 16px;
      font-weight: 800;
      font-size: 16px;
    }

    .score-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .game-area {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 24px;
      padding: 24px;
      min-height: 400px;
    }

    @media (max-width: 480px) {
      .game-area {
        min-height: auto;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
    }

    .question-container {
      margin-bottom: 24px;
    }

    @media (max-width: 480px) {
      .question-container {
        margin-bottom: 8px;
      }
    }

    .question-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 16px;
      color: var(--text-color);
      text-align: center;
    }

    @media (max-width: 480px) {
      .question-title {
        font-size: 12px;
        margin-bottom: 6px;
      }
    }

    .pinyin-display {
      font-size: 32px;
      font-weight: 800;
      text-align: center;
      color: var(--secondary-color);
      margin: 20px 0;
      padding: 20px;
      background: #ddf4ff;
      border-radius: 16px;
    }

    @media (max-width: 768px) {
      .pinyin-display {
        font-size: 24px;
        margin: 16px 0;
        padding: 16px;
      }
    }

    @media (max-width: 480px) {
      .pinyin-display {
        font-size: 16px;
        margin: 6px 0;
        padding: 8px;
      }
    }

    .play-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      font-size: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px auto;
      box-shadow: 0 6px 0 var(--primary-hover);
      transition: all 0.2s;
    }

    @media (max-width: 768px) {
      .play-btn {
        width: 60px;
        height: 60px;
        font-size: 28px;
        margin: 12px auto;
      }
    }

    @media (max-width: 480px) {
      .play-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
        margin: 6px auto;
        box-shadow: 0 3px 0 var(--primary-hover);
      }
    }

    .play-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 0 var(--primary-hover);
    }

    .play-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 var(--primary-hover);
    }

    .play-btn.playing {
      background: var(--accent-color);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .options-grid {
        gap: 12px;
        margin-top: 16px;
      }
    }

    @media (max-width: 480px) {
      .options-grid {
        gap: 8px;
        margin-top: 12px;
      }
    }

    .option-btn {
      padding: 30px 20px;
      border: 3px solid var(--border-color);
      border-radius: 16px;
      background: white;
      font-size: 48px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--border-color);
    }

    @media (max-width: 768px) {
      .option-btn {
        padding: 20px 16px;
        font-size: 32px;
        border-radius: 12px;
      }
    }

    @media (max-width: 480px) {
      .option-btn {
        padding: 10px 6px;
        font-size: 22px;
        border-radius: 8px;
        border-width: 2px;
        box-shadow: 0 2px 0 var(--border-color);
      }
    }

    .option-btn:hover {
      background: #f7f7f7;
      transform: translateY(-2px);
    }

    .option-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--border-color);
    }

    .option-btn.selected {
      border-color: var(--secondary-color);
      background: #ddf4ff;
      color: var(--secondary-color);
    }

    .option-btn.correct {
      border-color: var(--success-color);
      background: #e8f5e9;
      color: var(--success-color);
      animation: correctPulse 0.5s;
    }

    .option-btn.wrong {
      border-color: var(--error-color);
      background: #ffebee;
      color: var(--error-color);
      animation: shake 0.5s;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .option-btn.disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      margin-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    .btn {
      padding: 16px 32px;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--border-color);
    }

    @media (max-width: 768px) {
      .controls {
        margin-top: 20px;
        margin-bottom: calc(16px + env(safe-area-inset-bottom));
        gap: 12px;
      }
      .btn {
        padding: 12px 20px;
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      .controls {
        margin-top: 16px;
        margin-bottom: calc(12px + env(safe-area-inset-bottom));
        gap: 8px;
        flex-direction: column;
      }
      .btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
      }
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-hover);
      box-shadow: 0 4px 0 var(--primary-hover);
    }

    .btn-primary:active {
      transform: translateY(4px);
      box-shadow: 0 0 0;
    }

    .btn-secondary {
      background: white;
      color: var(--text-color);
    }

    .btn-secondary:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--border-color);
    }

    .result-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .result-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 16px;
      color: var(--text-color);
    }

    .result-score {
      font-size: 48px;
      font-weight: 800;
      color: var(--primary-color);
      margin: 24px 0;
    }

    .result-details {
      font-size: 18px;
      color: #777;
      margin-bottom: 24px;
      line-height: 1.8;
    }

    .celebration {
      font-size: 64px;
      margin: 20px 0;
      animation: bounce 0.5s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .wrong-answers-section {
      margin: 24px 0;
      padding: 16px;
      background: #fff9e6;
      border-radius: 12px;
      text-align: left;
    }

    .wrong-answers-title {
      font-size: 16px;
      font-weight: 800;
      color: #ff8800;
      margin-bottom: 12px;
      text-align: center;
    }

    .wrong-answer-item {
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 2px solid #ffc107;
    }

    .wrong-answer-hanzi {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 6px;
      text-align: center;
    }

    .wrong-answer-info {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .wrong-answer-selected {
      color: #dc3545;
      margin-bottom: 4px;
    }

    .wrong-answer-correct {
      color: #28a745;
    }

    @media (max-width: 768px) {
      .result-screen {
        padding: 24px 16px;
      }

      .result-title {
        font-size: 24px;
        margin-bottom: 12px;
      }

      .result-score {
        font-size: 36px;
        margin: 16px 0;
      }

      .result-details {
        font-size: 15px;
        margin-bottom: 20px;
      }

      .celebration {
        font-size: 48px;
        margin: 12px 0;
      }

      .wrong-answers-section {
        margin: 20px 0;
        padding: 12px;
      }

      .wrong-answers-title {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .wrong-answer-item {
        margin-bottom: 10px;
        padding: 10px;
      }

      .wrong-answer-hanzi {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .wrong-answer-info {
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .result-screen {
        padding: 20px 12px;
      }

      .result-title {
        font-size: 20px;
        margin-bottom: 10px;
      }

      .result-score {
        font-size: 32px;
        margin: 12px 0;
      }

      .result-details {
        font-size: 14px;
        margin-bottom: 16px;
      }

      .celebration {
        font-size: 40px;
        margin: 10px 0;
      }

      .wrong-answers-section {
        margin: 16px 0;
        padding: 10px;
      }

      .wrong-answers-title {
        font-size: 13px;
        margin-bottom: 8px;
      }

      .wrong-answer-item {
        margin-bottom: 8px;
        padding: 8px;
      }

      .wrong-answer-hanzi {
        font-size: 18px;
        margin-bottom: 4px;
      }

      .wrong-answer-info {
        font-size: 11px;
      }
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 20px;
      font-weight: 800;
      color: #777;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .header {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 16px;
        flex-direction: column;
        align-items: flex-start;
      }
      .header-title {
        font-size: 16px;
      }
      .score-info {
        font-size: 12px;
        gap: 8px;
      }
      .game-area {
        padding: 10px;
        border-radius: 16px;
        min-height: auto;
        margin-bottom: calc(16px + env(safe-area-inset-bottom));
      }
      .question-title {
        font-size: 15px;
        margin-bottom: 8px;
      }
      .options-grid {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 10px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 6px;
        padding-bottom: calc(6px + env(safe-area-inset-bottom));
      }
      .header {
        padding: 8px 10px;
        margin-bottom: 8px;
        border-radius: 12px;
      }
      .header-title {
        font-size: 14px;
      }
      .score-info {
        font-size: 10px;
        gap: 6px;
      }
      .game-area {
        padding: 6px;
        border-radius: 12px;
        min-height: auto;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        margin-bottom: 0;
      }
      .question-title {
        font-size: 12px;
        margin-bottom: 5px;
      }
      .options-grid {
        gap: 5px;
        margin-top: 5px;
      }
      .controls {
        margin-top: 10px;
        margin-bottom: 0;
        padding-bottom: max(60px, env(safe-area-inset-bottom));
      }
      .btn {
        padding: 10px;
        font-size: 13px;
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-title">üéß Âê¨Èü≥ÈÄâÂ≠ó</div>
    <div class="score-info">
      <div class="score-item">
        <span>È¢òÁõÆ:</span>
        <span id="currentQuestion">0</span>/<span id="totalQuestions">0</span>
      </div>
      <div class="score-item">
        <span>ÂæóÂàÜ:</span>
        <span id="currentScore">0</span>
      </div>
    </div>
  </div>

  <div class="game-area" id="gameArea">
    <div class="loading">Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆ...</div>
  </div>
</div>

<script>
// ÂÆâÂÖ®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
let currentUser = null;
try {
  const userStr = localStorage.getItem("currentUser");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
} catch (err) {
  console.error("Ëß£ÊûêÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•Ôºö", err);
  currentUser = null;
}
let questions = [];
let currentQuestionIndex = 0;
let answers = [];
let score = 0;
let hasAnswered = false;

function getVoiceSettingsSafe() {
  try {
    const raw = localStorage.getItem('voiceSettings');
    return raw ? JSON.parse(raw) : { rate: 0.8, voiceName: null };
  } catch (e) {
    return { rate: 0.8, voiceName: null };
  }
}

function speakText(text) {
  return new Promise((resolve) => {
    const content = (text || '').trim();
    if (!content) return resolve();

    const synth = window.speechSynthesis;
    if (!synth) {
      try {
        if (window.parent && typeof window.parent.speak === 'function') {
          window.parent.speak(content, 'chinese');
        }
      } catch (e) {}
      return resolve();
    }

    const settings = getVoiceSettingsSafe();
    const u = new SpeechSynthesisUtterance(content);
    u.lang = 'zh-CN';
    u.rate = settings.rate || 0.8;

    try {
      if (settings.voiceName && settings.voiceName !== 'default') {
        const voices = synth.getVoices();
        const v = voices.find(x => x.name === settings.voiceName);
        if (v) u.voice = v;
      }
    } catch (e) {}

    u.onend = () => resolve();
    u.onerror = () => resolve();

    try {
      synth.cancel();
      synth.speak(u);
    } catch (e) {
      resolve();
    }
  });
}

async function startGame() {
  if (!currentUser) {
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">ËØ∑ÂÖàÁôªÂΩï</div></div>';
    return;
  }

  try {
    const res = await fetch("/api/game-listen", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: currentUser.user_id, count: 10 })
    });

    if (!res.ok) {
      const data = await res.json();
      document.getElementById("gameArea").innerHTML = `<div class="result-screen"><div class="result-title">${data.error || "Âä†ËΩΩÂ§±Ë¥•"}</div></div>`;
      return;
    }

    const data = await res.json();
    questions = data.questions || [];
    
    if (questions.length === 0) {
      document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">ËØ∑ÂÖàÊ∑ªÂä†‰∏Ä‰∫õÁîüÂ≠ó</div></div>';
      return;
    }

    answers = [];
    currentQuestionIndex = 0;
    score = 0;
    hasAnswered = false;
    
    document.getElementById("totalQuestions").textContent = questions.length;
    showQuestion();
  } catch (err) {
    console.error("Âä†ËΩΩÈ¢òÁõÆÂ§±Ë¥•Ôºö", err);
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div></div>';
  }
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    showResult();
    return;
  }

  const question = questions[currentQuestionIndex];
  const selectedId = answers[currentQuestionIndex]?.selected_hanzi_id || null;
  hasAnswered = false;

  document.getElementById("currentQuestion").textContent = currentQuestionIndex + 1;
  
  const optionsHtml = question.options.map((option, idx) => {
    const isSelected = option.id === selectedId;
    return `
      <button class="option-btn ${isSelected ? 'selected' : ''}" 
              onclick="selectOption(${option.id})"
              data-id="${option.id}">
        ${option.hanzi}
      </button>
    `;
  }).join("");

  document.getElementById("gameArea").innerHTML = `
    <div class="question-container">
      <div class="question-title">ËØ∑Âê¨ËØªÈü≥ÔºåÈÄâÊã©Ê≠£Á°ÆÁöÑÊ±âÂ≠óÔºö</div>
      <div class="pinyin-display">${question.pinyin}</div>
      <button class="play-btn" id="playBtn" onclick="playSound()">üîä</button>
      <div class="options-grid">
        ${optionsHtml}
      </div>
      <div class="controls">
        <button class="btn btn-primary" onclick="nextQuestion()" ${!selectedId ? 'disabled style="opacity:0.5"' : ''}>
          ${currentQuestionIndex === questions.length - 1 ? 'ÂÆåÊàê' : '‰∏ã‰∏ÄÈ¢ò'}
        </button>
        <button class="btn btn-secondary" onclick="startGame()">ÈáçÊñ∞ÂºÄÂßã</button>
      </div>
    </div>
  `;

  // Ëá™Âä®Êí≠Êîæ‰∏ÄÊ¨° - ‰ΩøÁî® requestAnimationFrame Á°Æ‰øù DOM Â∑≤Ê∏≤Êüì
  requestAnimationFrame(() => {
    // Á¨¨‰∏ÄÈ¢òÊó∂ÈúÄË¶ÅÊõ¥ÈïøÁöÑÂª∂ËøüÔºåÁ°Æ‰øùÊµèËßàÂô®ÂáÜÂ§áÂ•ΩÊí≠ÊîæÈü≥È¢ë
    const delay = currentQuestionIndex === 0 ? 800 : 500;
    setTimeout(() => playSound(), delay);
  });
}

async function playSound() {
  const question = questions[currentQuestionIndex];
  if (!question) return;

  const btn = document.getElementById("playBtn");
  if (btn) {
    btn.classList.add("playing");
    btn.disabled = true;
  }

  await speakText(`${question.hanzi}ÔºåÊãºÈü≥Ôºö${question.pinyin}`);

  if (btn) {
    btn.classList.remove("playing");
    btn.disabled = false;
  }
}

function selectOption(hanziId) {
  if (hasAnswered) return;

  const question = questions[currentQuestionIndex];
  const isCorrect = question.word_id === hanziId;
  hasAnswered = true;

  if (!answers[currentQuestionIndex]) {
    answers[currentQuestionIndex] = {
      word_id: question.word_id,
      selected_hanzi_id: hanziId
    };
  } else {
    answers[currentQuestionIndex].selected_hanzi_id = hanziId;
  }

  // Êõ¥Êñ∞UIÊòæÁ§∫Ê≠£Á°Æ/ÈîôËØØ
  document.querySelectorAll(".option-btn").forEach(btn => {
    btn.classList.remove("selected", "correct", "wrong", "disabled");
    const btnId = parseInt(btn.dataset.id);
    
    if (btnId === hanziId) {
      if (isCorrect) {
        btn.classList.add("correct");
        score += 10;
        document.getElementById("currentScore").textContent = score;
      } else {
        btn.classList.add("wrong");
      }
    }
    
    if (btnId === question.word_id && isCorrect === false) {
      btn.classList.add("correct");
    }
    
    btn.classList.add("disabled");
  });

  // ÂêØÁî®‰∏ã‰∏ÄÈ¢òÊåâÈíÆ
  const nextBtn = document.querySelector(".btn-primary");
  if (nextBtn) {
    nextBtn.disabled = false;
    nextBtn.style.opacity = "1";
  }
}

function nextQuestion() {
  if (!answers[currentQuestionIndex]?.selected_hanzi_id) {
    return;
  }
  
  currentQuestionIndex++;
  showQuestion();
}

async function showResult() {
  try {
    const res = await fetch("/api/game-listen/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.user_id,
        answers: answers
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      document.getElementById("gameArea").innerHTML = `<div class="result-screen"><div class="result-title">${data.error || "Êèê‰∫§Â§±Ë¥•"}</div></div>`;
      return;
    }

    const correctCount = data.correct_count || 0;
    const totalCount = data.total_count || 0;
    const finalScore = data.score || 0;
    const expEarned = data.exp_earned || 0;
    const maxConsecutive = data.max_consecutive || 0;
    const isPerfect = correctCount === totalCount;
    const results = data.results || [];

    let celebration = "";
    if (isPerfect) {
      celebration = '<div class="celebration">üéâ ÂÆåÁæéÔºÅ</div>';
    } else if (correctCount >= totalCount * 0.8) {
      celebration = '<div class="celebration">üåü ÂæàÊ£íÔºÅ</div>';
    } else if (correctCount >= totalCount * 0.6) {
      celebration = '<div class="celebration">üëç ‰∏çÈîôÔºÅ</div>';
    }

    let consecutiveInfo = "";
    if (maxConsecutive >= 3) {
      consecutiveInfo = `<div style="color: var(--accent-color); font-weight: 800; margin-top: 8px;">ËøûÁª≠Á≠îÂØπ ${maxConsecutive} È¢òÔºÅ</div>`;
    }

    // ÁîüÊàêÈîôËØØÈ¢òÁõÆËØ¶ÁªÜ‰ø°ÊÅØ
    let wrongAnswersHtml = "";
    const wrongAnswers = results.filter((item, index) => {
      if (!item.correct) {
        // ÊâæÂà∞Áî®Êà∑ÈÄâÊã©ÁöÑÊ±âÂ≠ó
        const selectedAnswer = answers[index];
        const selectedOption = questions[index]?.options?.find(opt => opt.id === selectedAnswer?.selected_hanzi_id);
        item.selected_hanzi = selectedOption ? selectedOption.hanzi : 'Êú™ÈÄâÊã©';
        return true;
      }
      return false;
    });

    if (wrongAnswers.length > 0) {
      wrongAnswersHtml = `
        <div class="wrong-answers-section">
          <div class="wrong-answers-title">üìù ÈîôËØØÈ¢òÁõÆËØ¶ÊÉÖ</div>
          ${wrongAnswers.map(item => `
            <div class="wrong-answer-item">
              <div class="wrong-answer-hanzi">${item.correct_hanzi}</div>
              <div class="wrong-answer-info">
                <div style="color: #999; margin-bottom: 4px;">ÊãºÈü≥Ôºö${item.pinyin}</div>
                <div class="wrong-answer-selected">‚ùå ‰Ω†ÈÄâÁöÑÔºö${item.selected_hanzi}</div>
                <div class="wrong-answer-correct">‚úì Ê≠£Á°ÆÁ≠îÊ°àÔºö${item.correct_hanzi}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    document.getElementById("gameArea").innerHTML = `
      <div class="result-screen">
        ${celebration}
        <div class="result-title">Ê∏∏ÊàèÁªìÊùü</div>
        <div class="result-score">${finalScore} ÂàÜ</div>
        <div class="result-details">
          <div>Á≠îÂØπ: ${correctCount} / ${totalCount}</div>
          ${consecutiveInfo}
          <div>Ëé∑ÂæóÁªèÈ™å: +${expEarned} EXP</div>
        </div>
        ${wrongAnswersHtml}
        <div class="controls">
          <button class="btn btn-primary" onclick="startGame()">ÂÜçÊù•‰∏ÄÂ±Ä</button>
          <button class="btn btn-secondary" onclick="if(window.parent && window.parent.switchPage){window.parent.switchPage('chinese');}else{window.location.href='chinese.html';}">ËøîÂõûÁîüÂ≠óÊú¨</button>
        </div>
      </div>
    `;

    // Êõ¥Êñ∞Áà∂È°µÈù¢ÁöÑÊ∏∏ÊàèÊï∞ÊçÆ
    if (window.parent && typeof window.parent.updateGameStats === 'function') {
      window.parent.updateGameStats();
    }
  } catch (err) {
    console.error("Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•Ôºö", err);
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï</div></div>';
  }
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂºÄÂßãÊ∏∏Êàè
if (currentUser) {
  startGame();
} else {
  document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">ËØ∑ÂÖàÁôªÂΩï</div></div>';
}
</script>
</body>
</html>
