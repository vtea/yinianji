<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¯­æ–‡ - ç”Ÿå­—å­¦ä¹ </title>
  <style>
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
    }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
      background: #ffffff;
      color: var(--text-color);
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    #list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 24px;
    }

    .word-wrapper {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 24px;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      box-shadow: 0 4px 0 var(--border-color);
      transition: all 0.2s;
      cursor: pointer;
    }

    .word-wrapper:hover {
      background-color: #f7f7f7;
      transform: translateY(-2px);
    }

    .word-wrapper:active {
      transform: translateY(4px);
      box-shadow: 0 0px 0 var(--border-color);
    }


    .word-display {
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #fff;
      border: 2px solid #333;
    }

    /* å°å­¦ç±³å­—æ ¼ï¼ˆåå­— + æ–œçº¿ï¼‰ */
    .word-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        linear-gradient(#ddd 1px, transparent 1px),
        linear-gradient(90deg, #ddd 1px, transparent 1px),
        linear-gradient(45deg, #eee 1px, transparent 1px),
        linear-gradient(-45deg, #eee 1px, transparent 1px);
      background-size:
        100% 1px,
        1px 100%,
        100% 100%,
        100% 100%;
      background-position:
        center,
        center,
        center,
        center;
      background-repeat: no-repeat;
      pointer-events: none;
    }

    .word-display ruby {
      font-size: 64px;
      font-weight: 800;
      z-index: 1;
      line-height: 1;
      color: #333;
      text-align: center;
    }

    .word-display rt {
      display: none;
    }

    .word-pinyin {
      font-size: 16px;
      font-weight: 800;
      color: var(--secondary-color);
      background: #ddf4ff;
      padding: 4px 12px;
      border-radius: 12px;
      opacity: 0;
      filter: blur(8px);
      transition: all 0.3s;
      cursor: pointer;
      user-select: none;
    }
    
    .word-pinyin.show {
      opacity: 1;
      filter: blur(0);
    }
    
    .word-pinyin:hover {
      background: #b3e5fc;
    }

    .word-info {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: 12px;
      font-weight: 800;
      color: #afafaf;
    }

    .remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      background: #ff4b4b;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 0 #d33131;
      transition: all 0.1s;
    }

    .remove-btn:active {
      transform: translateY(2px);
      box-shadow: 0 0 0;
    }

    .empty-message {
      text-align: center;
      color: #afafaf;
      padding: 60px 16px;
      font-size: 18px;
      font-weight: 800;
    }

    /* æ¸¸æˆåŒ–UI */
    .game-header {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .progress-bar-container {
      margin-bottom: 16px;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 800;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid var(--border-color);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 800;
    }

    .stats-row {
      display: flex;
      justify-content: space-around;
      gap: 16px;
      margin-top: 16px;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--secondary-color);
    }

    .stat-label {
      font-size: 12px;
      color: #777;
      font-weight: 700;
      margin-top: 4px;
    }

    .game-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .game-btn {
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      background: white;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--border-color);
      text-align: center;
    }

    .game-btn:hover {
      background: #f7f7f7;
      transform: translateY(-2px);
    }

    .game-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--border-color);
    }

    .game-btn.match {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .game-btn.listen {
      border-color: var(--secondary-color);
      color: var(--secondary-color);
    }

    .game-btn.spell {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    /* æŒæ¡åº¦æ ‡è¯† */
    .mastery-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 800;
      color: white;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .mastery-0 { background: #ccc; }
    .mastery-1 { background: #ff9800; }
    .mastery-2 { background: #ffc107; }
    .mastery-3 { background: #4caf50; }
    .mastery-4 { background: #2196f3; }
    .mastery-5 { background: #9c27b0; }

    /* å·²æŒæ¡ç”Ÿå­—æ ·å¼ */
    .word-wrapper.mastered-word {
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      border-color: var(--primary-color);
      border-width: 3px;
    }

    .word-wrapper.mastered-word:hover {
      background: linear-gradient(135deg, #c8e6c9 0%, #dcedc8 100%);
    }

    /* æˆå°±ç³»ç»Ÿ */
    .achievement-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 3px solid var(--accent-color);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideInRight 0.5s ease-out;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .achievement-badge.hide {
      animation: slideOutRight 0.5s ease-in forwards;
    }

    @keyframes slideOutRight {
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .achievement-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 8px;
    }

    .achievement-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent-color);
      text-align: center;
      margin-bottom: 4px;
    }

    .achievement-desc {
      font-size: 14px;
      color: #777;
      text-align: center;
    }

    .achievements-btn {
      position: fixed;
      bottom: 110px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent-color);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 6px 0 #e6b800;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 101;
      transition: all 0.2s;
    }

    .achievements-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #e6b800;
    }

    .achievements-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .achievements-modal.show {
      display: flex;
    }

    .achievements-content {
      background: white;
      padding: 28px 24px;
      border-radius: 24px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 12px 0 rgba(0,0,0,0.1);
      border: 2px solid var(--border-color);
    }

    /* ç†Ÿç»ƒæŒæ¡å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      padding: 20px;
      box-sizing: border-box;
    }

    .modal.show {
      display: flex;
    }

    .mastered-modal-content {
      background: white;
      padding: 28px 24px;
      border-radius: 24px;
      width: 90%;
      max-width: 420px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      position: relative;
      box-shadow: 0 12px 0 rgba(0,0,0,0.1);
      border: 2px solid var(--border-color);
      margin: auto;
      display: flex;
      flex-direction: column;
    }

    .mastered-modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .mastered-modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .mastered-modal-content::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .mastered-modal-content::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .achievements-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent-color);
      margin-bottom: 24px;
      text-align: center;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }

    .achievement-item {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s;
    }

    .achievement-item.unlocked {
      border-color: var(--accent-color);
      background: #fffbf0;
    }

    .achievement-item.locked {
      opacity: 0.5;
      filter: grayscale(100%);
    }

    .achievement-item-icon {
      font-size: 40px;
      margin-bottom: 8px;
    }

    .achievement-item-name {
      font-size: 14px;
      font-weight: 800;
      color: var(--text-color);
      margin-bottom: 4px;
    }

    .achievement-item-desc {
      font-size: 11px;
      color: #777;
    }

    /* ç²’å­åŠ¨ç”» */
    .particle {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      font-size: 20px;
      animation: particleFloat 1s ease-out forwards;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(0);
        opacity: 0;
      }
    }

    /* å‡çº§ç‰¹æ•ˆ */
    .level-up-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10001;
      text-align: center;
      pointer-events: none;
    }

    .level-up-text {
      font-size: 64px;
      font-weight: 800;
      color: var(--primary-color);
      animation: levelUpPulse 1s ease-out;
    }

    @keyframes levelUpPulse {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }

    @media (max-width: 768px) {
      .game-header {
        padding: 16px;
      }
      .progress-info {
        font-size: 12px;
      }

      .mastered-modal-content {
        max-height: calc(100vh - 80px);
        padding: 20px 16px;
        width: 95%;
      }

      .mastered-modal-content #masteredWord {
        font-size: 48px !important;
      }

      .mastered-modal-content .btn {
        padding: 12px 16px;
        font-size: 14px;
      }
      .stat-value {
        font-size: 20px;
      }
      .stat-label {
        font-size: 11px;
      }
      .game-buttons {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .game-btn {
        padding: 12px;
        font-size: 14px;
      }
      .achievements-btn {
        bottom: 90px;
        right: 20px;
        width: 48px;
        height: 48px;
        font-size: 20px;
      }
      .achievement-badge {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: calc(100% - 20px);
        padding: 16px;
      }
      .achievements-content {
        width: 95%;
        padding: 20px 16px;
      }
      .achievements-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .achievements-btn {
        bottom: 80px;
        right: 16px;
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      .game-header {
        padding: 12px;
      }
      .progress-bar {
        height: 16px;
      }
      .progress-info {
        font-size: 11px;
      }
      .stat-value {
        font-size: 18px;
      }
      .stat-label {
        font-size: 10px;
      }
      .game-buttons {
        gap: 6px;
      }
      .game-btn {
        padding: 10px;
        font-size: 13px;
      }
      #list {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      .word-wrapper {
        padding: 12px;
      }
      .word-display {
        font-size: 32px;
      }
      .stats-row {
        flex-wrap: wrap;
        gap: 8px;
      }
      .game-header {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="game-header" id="gameHeader" style="display: none;">
    <div class="progress-bar-container">
      <div class="progress-info">
        <span>ç­‰çº§ <span id="userLevel">1</span></span>
        <span><span id="currentExp">0</span> / <span id="nextLevelExp">150</span> EXP</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-value" id="totalStars">0</div>
        <div class="stat-label">â­ æ˜Ÿæ˜Ÿ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="consecutiveDays">0</div>
        <div class="stat-label">ğŸ”¥ è¿ç»­</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalWords">0</div>
        <div class="stat-label">ğŸ“š ç”Ÿå­—</div>
      </div>
    </div>
    <div class="game-buttons">
      <button class="game-btn match" onclick="startGame('match')">ğŸ® é…å¯¹æ¸¸æˆ</button>
      <button class="game-btn listen" onclick="startGame('listen')">ğŸ§ å¬éŸ³é€‰å­—</button>
      <button class="game-btn spell" onclick="startGame('spell')">âœï¸ æ‹¼å†™æ¸¸æˆ</button>
    </div>
  </div>
  <div id="list"></div>
</div>

<!-- æˆå°±å¼¹çª— -->
<div class="achievement-badge" id="achievementBadge" style="display: none;">
  <div class="achievement-icon" id="achievementIcon">ğŸ†</div>
  <div class="achievement-title" id="achievementTitle">æˆå°±è§£é”ï¼</div>
  <div class="achievement-desc" id="achievementDesc">æ­å–œä½ è·å¾—æ–°æˆå°±</div>
</div>

<!-- æˆå°±åˆ—è¡¨æ¨¡æ€æ¡† -->
<div class="achievements-modal" id="achievementsModal" onclick="closeAchievementsModal(event)">
  <div class="achievements-content" onclick="event.stopPropagation()">
    <div class="achievements-title">ğŸ† æˆ‘çš„æˆå°±</div>
    <div class="achievements-grid" id="achievementsGrid"></div>
    <div style="text-align: center; margin-top: 24px;">
      <button class="btn btn-primary" onclick="closeAchievementsModal()" style="padding: 12px 32px;">å…³é—­</button>
    </div>
  </div>
</div>

<!-- æˆå°±æŒ‰é’® -->
<button class="achievements-btn" onclick="showAchievements()" title="æŸ¥çœ‹æˆå°±">ğŸ†</button>

<!-- ç†Ÿç»ƒæŒæ¡æç¤ºå¼¹çª— -->
<div class="modal" id="masteredModal" onclick="closeModal('masteredModal', event)">
  <div class="modal-content mastered-modal-content" onclick="event.stopPropagation()">
    <div class="celebration" style="font-size: 48px; text-align: center; margin-bottom: 16px;">ğŸ‰</div>
    <h3 class="modal-title" style="margin-top:0; font-size:24px; font-weight:800; color: var(--primary-color); text-align: center;">
      æ­å–œï¼ä½ å·²ç»ç†Ÿç»ƒæŒæ¡
    </h3>
    <div style="text-align: center; margin: 20px 0;">
      <div id="masteredWord" style="font-size: 64px; font-weight: 800; color: var(--secondary-color); margin: 10px 0;"></div>
      <div id="masteredPinyin" style="font-size: 20px; color: #777; font-weight: 700;"></div>
    </div>
    <div style="background: #fffbf0; border: 2px solid var(--accent-color); border-radius: 16px; padding: 16px; margin: 20px 0; text-align: center;">
      <div style="font-size: 16px; font-weight: 800; color: var(--text-color); margin-bottom: 8px;">å¥–åŠ±é¢„è§ˆ</div>
      <div style="display: flex; justify-content: center; gap: 24px; font-size: 18px; font-weight: 800;">
        <div style="color: var(--primary-color);">+50 EXP</div>
        <div style="color: var(--accent-color);">+2 â­</div>
      </div>
    </div>
    <div style="display: flex; gap: 12px; margin-top: 24px; margin-bottom: 0;">
      <button class="btn btn-secondary" onclick="closeModal('masteredModal')" style="flex: 1;">ç¨åå†è¯´</button>
      <button class="btn btn-primary" id="moveToKnownBtn" onclick="moveToKnown()" style="flex: 1;">ç§»åˆ°å·²è®¤è¯†</button>
    </div>
  </div>
</div>

<script>
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

// ä»localStorageåŠ è½½å·²æ˜¾ç¤ºçš„æˆå°±åˆ—è¡¨
function loadShownAchievements() {
  const saved = localStorage.getItem("shownAchievements");
  return saved ? new Set(JSON.parse(saved)) : new Set();
}

// ä¿å­˜å·²æ˜¾ç¤ºçš„æˆå°±åˆ—è¡¨åˆ°localStorage
function saveShownAchievements(achievementIds) {
  localStorage.setItem("shownAchievements", JSON.stringify(Array.from(achievementIds)));
}

let gameStats = null;

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString();
}

function startGame(gameType) {
  const gameMap = {
    'match': 'chinese-match-game.html',
    'listen': 'chinese-listen-game.html',
    'spell': 'chinese-spell-game.html'
  };
  
  if (window.parent && window.parent.switchPage) {
    // å¦‚æœæ˜¯åœ¨iframeä¸­ï¼Œé€šè¿‡çˆ¶çª—å£åˆ‡æ¢
    const gameName = gameType + '-game';
    window.parent.switchPage(gameName);
  } else {
    // ç›´æ¥è·³è½¬
    window.location.href = gameMap[gameType];
  }
}

function loadGameStats() {
  if (!currentUser) return;
  
  fetch(`/api/game-stats/${currentUser.user_id}`)
    .then(res => res.json())
    .then(data => {
      if (data && !data.error) {
        gameStats = data;
        updateGameUI(data);
      }
    })
    .catch(err => {
      console.error("åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥ï¼š", err);
    });
}

let previousLevel = null; // åˆå§‹åŒ–ä¸ºnullï¼Œé¦–æ¬¡åŠ è½½æ—¶ä¸è§¦å‘å‡çº§åŠ¨ç”»

function updateGameUI(stats) {
  if (!stats) return;
  
  const currentLevel = stats.current_level || 1;
  
  // æ£€æŸ¥æ˜¯å¦å‡çº§ï¼ˆåªåœ¨éé¦–æ¬¡åŠ è½½æ—¶æ£€æŸ¥ï¼‰
  if (previousLevel !== null && currentLevel > previousLevel) {
    showLevelUpEffect();
    createParticles(30);
  }
  previousLevel = currentLevel;
  
  document.getElementById("userLevel").textContent = currentLevel;
  document.getElementById("currentExp").textContent = stats.current_level_exp || 0;
  document.getElementById("nextLevelExp").textContent = stats.exp_to_next_level || 150;
  document.getElementById("totalStars").textContent = stats.total_stars || 0;
  document.getElementById("consecutiveDays").textContent = stats.consecutive_days || 0;
  
  // æ›´æ–°è¿›åº¦æ¡
  const expForCurrent = stats.exp_for_current_level || 0;
  const expForNext = stats.exp_for_next_level || 150;
  const currentExp = stats.current_level_exp || 0;
  const expNeeded = expForNext - expForCurrent;
  const progress = expNeeded > 0 
    ? Math.min(100, Math.max(0, (currentExp / expNeeded) * 100))
    : 100;
  
  const progressFill = document.getElementById("progressFill");
  if (progressFill) {
    progressFill.style.width = progress.toFixed(1) + "%";
    progressFill.textContent = progress >= 5 ? Math.round(progress) + "%" : "";
  }
  
  // æ˜¾ç¤ºæ¸¸æˆå¤´éƒ¨
  const gameHeader = document.getElementById("gameHeader");
  if (gameHeader) {
    gameHeader.style.display = "block";
  }
}

function updateGameStats() {
  loadGameStats();
  checkNewAchievements();
  checkNewMasteredWords();
}

let lastAchievements = loadShownAchievements(); // å·²æ˜¾ç¤ºè¿‡çš„æˆå°±IDé›†åˆï¼ˆä»localStorageåŠ è½½ï¼‰
let lastMasteredWords = new Set(); // å·²æŒæ¡çš„ç”Ÿå­—IDé›†åˆ

let isCheckingAchievements = false;
let isCheckingMastered = false;
let currentMasteredWord = null; // å½“å‰è¦å¤„ç†çš„å·²æŒæ¡ç”Ÿå­—

function checkNewAchievements() {
  if (!currentUser || isCheckingAchievements) return;
  isCheckingAchievements = true;
  
  // å…ˆæ£€æŸ¥æ–°æˆå°±
  fetch(`/api/check-achievements/${currentUser.user_id}`)
    .then(res => res.json())
    .then(data => {
      // ç„¶åè·å–å®Œæ•´æˆå°±åˆ—è¡¨
      return fetch(`/api/achievements/${currentUser.user_id}`)
        .then(res => res.json())
        .then(achievements => {
          const unlockedIds = new Set(achievements.filter(a => a.unlocked).map(a => a.id));
          // åªæ˜¾ç¤ºçœŸæ­£æ–°è§£é”çš„æˆå°±ï¼ˆå·²è§£é”ä½†ä¹‹å‰æ²¡æœ‰æ˜¾ç¤ºè¿‡çš„ï¼‰
          const newAchievements = achievements.filter(a => a.unlocked && !lastAchievements.has(a.id));
          
          if (newAchievements.length > 0) {
            newAchievements.forEach((achievement, index) => {
              // å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…å¤šä¸ªæˆå°±åŒæ—¶å¼¹å‡º
              setTimeout(() => {
                showAchievementUnlock(achievement);
                // æ ‡è®°ä¸ºå·²æ˜¾ç¤º
                lastAchievements.add(achievement.id);
                saveShownAchievements(lastAchievements);
              }, index * 3500);
            });
          } else {
            // å³ä½¿æ²¡æœ‰æ–°æˆå°±ï¼Œä¹Ÿæ›´æ–°å·²è§£é”çš„æˆå°±åˆ—è¡¨ï¼ˆç”¨äºåŒæ­¥ï¼‰
            // ä½†åªæ›´æ–°å·²è§£é”çš„ï¼Œä¸æ·»åŠ æ–°çš„
            const currentUnlocked = Array.from(unlockedIds);
            const shown = Array.from(lastAchievements);
            // åˆå¹¶ï¼šä¿ç•™å·²æ˜¾ç¤ºçš„ï¼Œæ·»åŠ æ–°è§£é”çš„ï¼ˆä½†ä¸æ˜¾ç¤ºï¼Œå› ä¸ºå¯èƒ½ä¹‹å‰å·²ç»æ˜¾ç¤ºè¿‡ï¼‰
            const merged = new Set([...shown, ...currentUnlocked]);
            lastAchievements = merged;
            saveShownAchievements(lastAchievements);
          }
          
          isCheckingAchievements = false;
        })
        .catch(err => {
          console.error("è·å–æˆå°±åˆ—è¡¨å¤±è´¥ï¼š", err);
          isCheckingAchievements = false;
        });
    })
    .catch(err => {
      console.error("æ£€æŸ¥æˆå°±å¤±è´¥ï¼š", err);
      isCheckingAchievements = false;
    });
}

function showAchievementUnlock(achievement) {
  const badge = document.getElementById("achievementBadge");
  const icon = document.getElementById("achievementIcon");
  const title = document.getElementById("achievementTitle");
  const desc = document.getElementById("achievementDesc");
  
  if (badge && icon && title && desc) {
    icon.textContent = achievement.icon || "ğŸ†";
    title.textContent = achievement.name || "æˆå°±è§£é”ï¼";
    desc.textContent = achievement.desc || "æ­å–œä½ è·å¾—æ–°æˆå°±";
    
    badge.style.display = "block";
    badge.classList.remove("hide");
    
    // åˆ›å»ºç²’å­æ•ˆæœ
    createParticles(20);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
      badge.classList.add("hide");
      setTimeout(() => {
        badge.style.display = "none";
        badge.classList.remove("hide");
      }, 500);
    }, 3000);
  }
}

function createParticles(count) {
  const particles = ["â­", "âœ¨", "ğŸ‰", "ğŸŒŸ", "ğŸ’«"];
  for (let i = 0; i < count; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.textContent = particles[Math.floor(Math.random() * particles.length)];
    particle.style.left = Math.random() * 100 + "%";
    particle.style.top = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 0.3 + "s";
    document.body.appendChild(particle);
    
    setTimeout(() => {
      particle.remove();
    }, 1000);
  }
}

function showAchievements() {
  if (!currentUser) return;
  
  fetch(`/api/achievements/${currentUser.user_id}`)
    .then(res => res.json())
    .then(achievements => {
      const grid = document.getElementById("achievementsGrid");
      if (!grid) return;
      
      grid.innerHTML = achievements.map(achievement => `
        <div class="achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}">
          <div class="achievement-item-icon">${achievement.icon || "ğŸ†"}</div>
          <div class="achievement-item-name">${achievement.name}</div>
          <div class="achievement-item-desc">${achievement.desc}</div>
        </div>
      `).join("");
      
      document.getElementById("achievementsModal").classList.add("show");
    })
    .catch(err => {
      console.error("åŠ è½½æˆå°±å¤±è´¥ï¼š", err);
      alert("åŠ è½½æˆå°±å¤±è´¥");
    });
}

function closeAchievementsModal(e) {
  if (!e || e.target.id === "achievementsModal") {
    document.getElementById("achievementsModal").classList.remove("show");
  }
}

function closeModal(modalId, e) {
  if (!e || e.target.id === modalId || !modalId.includes('event')) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("show");
      
      // æ¢å¤FABæŒ‰é’®æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (window.parent) {
        try {
          const fabBtn = window.parent.document.getElementById("fabBtn");
          if (fabBtn && window.parent.location.pathname.includes('chinese')) {
            fabBtn.style.display = "flex";
          }
        } catch (err) {
          // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥
        }
      }
    }
  }
}

function showLevelUpEffect() {
  const effect = document.createElement("div");
  effect.className = "level-up-effect";
  effect.innerHTML = '<div class="level-up-text">ğŸ‰ å‡çº§å•¦ï¼</div>';
  document.body.appendChild(effect);
  
  setTimeout(() => {
    effect.remove();
  }, 1000);
}

// æ£€æŸ¥æ–°ç†Ÿç»ƒæŒæ¡çš„ç”Ÿå­—
function checkNewMasteredWords() {
  if (!currentUser || isCheckingMastered) return;
  isCheckingMastered = true;
  
  fetch(`/api/check-mastered/${currentUser.user_id}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(masteredWords => {
      if (!masteredWords || !Array.isArray(masteredWords)) {
        isCheckingMastered = false;
        return;
      }
      
      const masteredIds = new Set(masteredWords.map(w => w.word_id));
      const newMastered = masteredWords.filter(w => !lastMasteredWords.has(w.word_id));
      
      if (newMastered.length > 0) {
        // é€ä¸ªæ˜¾ç¤ºæç¤ºï¼ˆå»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…åŒæ—¶å¼¹å‡ºå¤šä¸ªï¼‰
        newMastered.forEach((word, index) => {
          setTimeout(() => {
            showMasteredModal(word);
          }, index * 4000);
        });
      }
      
      lastMasteredWords = masteredIds;
      isCheckingMastered = false;
    })
    .catch(err => {
      console.error("æ£€æŸ¥å·²æŒæ¡ç”Ÿå­—å¤±è´¥ï¼š", err);
      isCheckingMastered = false;
    });
}

// æ˜¾ç¤ºç†Ÿç»ƒæŒæ¡æç¤ºå¼¹çª—
function showMasteredModal(word) {
  currentMasteredWord = word;
  
  const modal = document.getElementById("masteredModal");
  const wordEl = document.getElementById("masteredWord");
  const pinyinEl = document.getElementById("masteredPinyin");
  
  if (modal && wordEl && pinyinEl) {
    wordEl.textContent = word.hanzi;
    pinyinEl.textContent = word.pinyin || "";
    modal.classList.add("show");
    
    // éšè—FABæŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (window.parent) {
      try {
        const fabBtn = window.parent.document.getElementById("fabBtn");
        if (fabBtn) {
          fabBtn.style.display = "none";
        }
      } catch (e) {
        // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥
      }
    }
    
    // åˆ›å»ºåº†ç¥ç²’å­æ•ˆæœ
    createParticles(25);
  }
}

// ç§»åˆ°å·²è®¤è¯†ï¼ˆåˆ é™¤å·²æŒæ¡çš„ç”Ÿå­—ï¼‰
function moveToKnown() {
  if (!currentMasteredWord || !currentUser) return;
  
  const wordId = currentMasteredWord.word_id;
  const hanzi = currentMasteredWord.hanzi;
  
  fetch("/api/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: wordId })
  })
  .then(res => res.json())
  .then(data => {
    if (data && data.success) {
      // æ˜¾ç¤ºå¥–åŠ±åŠ¨ç”»
      if (data.is_mastered) {
        showRewardAnimation(data.exp_reward || 50, data.stars_reward || 2);
      }
      
      // å…³é—­å¼¹çª—
      closeModal('masteredModal');
      currentMasteredWord = null;
      
      // ä»å·²æŒæ¡åˆ—è¡¨ä¸­ç§»é™¤
      lastMasteredWords.delete(wordId);
      
      // é‡æ–°åŠ è½½é¡µé¢
      loadChinesePage();
      updateGameStats();
      
      // æ›´æ–°ç»Ÿè®¡
      if (window.parent && typeof window.parent.updateWordStats === 'function') {
        window.parent.updateWordStats();
      }
    } else {
      alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
    }
  })
  .catch(err => {
    console.error("åˆ é™¤å¤±è´¥ï¼š", err);
    alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
  });
}

// æ˜¾ç¤ºå¥–åŠ±åŠ¨ç”»
function showRewardAnimation(exp, stars) {
  const rewardEl = document.createElement("div");
  rewardEl.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 3px solid var(--accent-color);
    border-radius: 24px;
    padding: 32px;
    text-align: center;
    z-index: 10002;
    box-shadow: 0 12px 24px rgba(0,0,0,0.3);
    animation: rewardPop 1s ease-out forwards;
  `;
  rewardEl.innerHTML = `
    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‰</div>
    <div style="font-size: 24px; font-weight: 800; color: var(--primary-color); margin-bottom: 16px;">
      è·å¾—å¥–åŠ±ï¼
    </div>
    <div style="font-size: 20px; font-weight: 800; color: var(--text-color);">
      <div style="color: var(--primary-color); margin-bottom: 8px;">+${exp} EXP</div>
      <div style="color: var(--accent-color);">+${stars} â­</div>
    </div>
  `;
  
  document.body.appendChild(rewardEl);
  
  setTimeout(() => {
    rewardEl.style.animation = "rewardFadeOut 0.5s ease-out forwards";
    setTimeout(() => {
      rewardEl.remove();
    }, 500);
  }, 2000);
}

// æ·»åŠ å¥–åŠ±åŠ¨ç”»æ ·å¼
const style = document.createElement("style");
style.textContent = `
  @keyframes rewardPop {
    0% {
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.1);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }
  @keyframes rewardFadeOut {
    to {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

function speakChinese(hanzi, py, wordId) {
  if (!hanzi) return;
  
  if (window.parent && window.parent.speak) {
    window.parent.speak(`${hanzi}ï¼Œæ‹¼éŸ³ï¼š${py}`, 'chinese');
  } else {
    const saved = localStorage.getItem("voiceSettings");
    const voiceSettings = saved ? JSON.parse(saved) : { rate: 0.8 };
    const u = new SpeechSynthesisUtterance(`${hanzi}ï¼Œæ‹¼éŸ³ï¼š${py}`);
    u.lang = "zh-CN";
    u.rate = voiceSettings.rate;
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(u);
    }, 50);
  }


  if (!currentUser) return;
  
  fetch("/api/speak", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: wordId })
  }).then(() => {
    loadChinesePage();
    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æŒæ¡çš„ç”Ÿå­—
    setTimeout(() => {
      checkNewMasteredWords();
    }, 500);
  });
}

function deleteChineseWord(event, word) {
  event.stopPropagation();
  const isMastered = word.is_mastered || 0;
  const confirmMsg = isMastered 
    ? `ç¡®å®šè¦å°† "${word.hanzi}" ç§»åˆ°å·²è®¤è¯†å—ï¼Ÿ\nï¼ˆå°†è·å¾— 50 EXP + 2 æ˜Ÿæ˜Ÿå¥–åŠ±ï¼‰`
    : `ç¡®å®šè¦åˆ é™¤ "${word.hanzi}" å—ï¼Ÿ`;
    
  if (confirm(confirmMsg)) {
    fetch("/api/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: word.id })
    })
    .then(res => res.json())
    .then(data => {
      if (data && data.success) {
        // å¦‚æœåˆ é™¤çš„æ˜¯å·²æŒæ¡çš„ç”Ÿå­—ï¼Œæ˜¾ç¤ºå¥–åŠ±åŠ¨ç”»
        if (data.is_mastered) {
          showRewardAnimation(data.exp_reward || 50, data.stars_reward || 2);
        }
        
        if (currentUser) {
          if (window.parent && typeof window.parent.updateWordStats === 'function') {
            window.parent.updateWordStats();
          }
        }
        loadChinesePage();
        updateGameStats();
      } else {
        alert("åˆ é™¤å¤±è´¥");
      }
    })
    .catch(err => {
      console.error("åˆ é™¤å¤±è´¥ï¼š", err);
      alert("åˆ é™¤å¤±è´¥");
    });
  }
}

function loadChinesePage() {
  if (!currentUser) return;

  // åŠ è½½æ¸¸æˆæ•°æ®
  loadGameStats();

  fetch(`/api/words/${currentUser.user_id}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("list");
      if (!list) return;
      list.innerHTML = "";

      // æ›´æ–°æ€»ç”Ÿå­—æ•°
      const totalWordsEl = document.getElementById("totalWords");
      if (totalWordsEl) {
        totalWordsEl.textContent = data.length;
      }

      if (data.length === 0) {
        list.innerHTML = "<div class='empty-message'>è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ç”Ÿå­—ï¼Œå¿«å»æ·»åŠ å§ï¼</div>";
        return;
      }

      data.forEach(w => {
        const wrapper = document.createElement("div");
        wrapper.className = "word-wrapper";

        const date = formatDate(w.created_at);
        const masteryLevel = w.mastery_level || 0;
        const isMastered = w.is_mastered || 0;
        
        // å·²æŒæ¡çš„ç”Ÿå­—æ·»åŠ ç‰¹æ®Šæ ·å¼
        if (isMastered) {
          wrapper.classList.add("mastered-word");
        }
        
        const masteryBadge = masteryLevel > 0 
          ? `<div class="mastery-badge mastery-${masteryLevel}" title="æŒæ¡åº¦ ${masteryLevel} çº§">${masteryLevel}</div>`
          : '';
        
        const masteredLabel = isMastered 
          ? `<div class="mastered-label" style="position: absolute; top: 8px; right: 8px; background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 800;">å·²æŒæ¡</div>`
          : '';
        
        wrapper.innerHTML = `
          <button class="remove-btn" type="button" ${isMastered ? 'title="ç§»åˆ°å·²è®¤è¯†"' : ''}>${isMastered ? 'âœ“' : 'âœ•'}</button>
          ${masteryBadge}
          ${masteredLabel}
          <div class="word-pinyin" title="ç‚¹å‡»æ˜¾ç¤º/éšè—æ‹¼éŸ³">${w.pinyin || ''}</div>
          <div class="word-display">
            <ruby>${w.hanzi}<rt>${w.pinyin || ''}</rt></ruby>
          </div>
          <div class="word-info">
            <span>ğŸ“… ${date}</span>
            <span class="speak-count">ğŸ”Š ${w.speak_count}</span>
          </div>
        `;

        const pinyinEl = wrapper.querySelector(".word-pinyin");
        
        // ç‚¹å‡»æ‹¼éŸ³åˆ‡æ¢æ˜¾ç¤º/éšè—
        pinyinEl.onclick = (e) => {
          e.stopPropagation();
          pinyinEl.classList.toggle('show');
        };
        
        // ç‚¹å‡»å¡ç‰‡æœ—è¯»
        wrapper.onclick = (e) => {
          if (!e.target.classList.contains('word-pinyin') && !e.target.classList.contains('remove-btn') && !e.target.classList.contains('mastery-badge')) {
            speakChinese(w.hanzi, w.pinyin, w.id);
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
            wrapper.style.transform = "scale(0.95)";
            setTimeout(() => {
              wrapper.style.transform = "";
            }, 150);
          }
        };
        
        // å·²æŒæ¡çš„ç”Ÿå­—ï¼Œåˆ é™¤æŒ‰é’®æ˜¾ç¤ºä¸åŒæç¤º
        const removeBtn = wrapper.querySelector(".remove-btn");
        if (isMastered) {
          removeBtn.style.background = "var(--primary-color)";
          removeBtn.style.color = "white";
          removeBtn.title = "ç§»åˆ°å·²è®¤è¯†ï¼ˆè·å¾—å¥–åŠ±ï¼‰";
        }
        removeBtn.onclick = (e) => {
          if (isMastered) {
            // å·²æŒæ¡çš„ç”Ÿå­—ï¼Œç›´æ¥ç§»åˆ°å·²è®¤è¯†ï¼ˆç»™äºˆå¥–åŠ±ï¼‰
            currentMasteredWord = { word_id: w.id, hanzi: w.hanzi, pinyin: w.pinyin };
            moveToKnown();
          } else {
            // æ™®é€šåˆ é™¤
            deleteChineseWord(e, w);
          }
        };

        list.appendChild(wrapper);
      });
    });
}

loadChinesePage();

// åˆå§‹åŒ–æ—¶å…ˆåŠ è½½å·²æ˜¾ç¤ºçš„æˆå°±åˆ—è¡¨ï¼Œç„¶åæ£€æŸ¥æ–°æˆå°±å’Œå·²æŒæ¡ç”Ÿå­—
function initializeAchievements() {
  if (!currentUser) return;
  
  // å…ˆè·å–å½“å‰å·²è§£é”çš„æˆå°±ï¼Œåˆå§‹åŒ–lastAchievementsï¼ˆé¿å…æ˜¾ç¤ºå·²è§£é”çš„æˆå°±ï¼‰
  fetch(`/api/achievements/${currentUser.user_id}`)
    .then(res => res.json())
    .then(achievements => {
      const unlockedIds = new Set(achievements.filter(a => a.unlocked).map(a => a.id));
      // åˆå¹¶å·²æ˜¾ç¤ºçš„æˆå°±å’Œå½“å‰å·²è§£é”çš„æˆå°±
      const merged = new Set([...lastAchievements, ...unlockedIds]);
      lastAchievements = merged;
      saveShownAchievements(lastAchievements);
    })
    .catch(err => {
      console.error("åˆå§‹åŒ–æˆå°±åˆ—è¡¨å¤±è´¥ï¼š", err);
    })
    .finally(() => {
      // å»¶è¿Ÿæ£€æŸ¥æ–°æˆå°±å’Œå·²æŒæ¡ç”Ÿå­—ï¼ˆé¿å…ä¸é¡µé¢åŠ è½½å†²çªï¼‰
      setTimeout(() => {
        checkNewAchievements();
        checkNewMasteredWords();
      }, 2000);
    });
}

if (currentUser) {
  initializeAchievements();
}

// æš´éœ²ç»™çˆ¶çª—å£çš„å‡½æ•°
if (window.parent) {
  window.parent.updateGameStats = updateGameStats;
}
</script>
</body>
</html>
