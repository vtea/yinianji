<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Â£∞ÊØçÈüµÊØç - ÊãºÈü≥Â≠¶‰π†</title>
  <style>
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
    }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
      background: #ffffff;
      color: var(--text-color);
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-color);
      margin: 40px 0 20px;
      padding-left: 12px;
      border-left: 6px solid var(--secondary-color);
    }

    .pinyin-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
    }

    .pinyin-btn {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      padding: 20px 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 0 var(--border-color);
    }

    .pinyin-btn:hover {
      background-color: #f7f7f7;
      transform: translateY(-2px);
    }

    .pinyin-btn:active {
      transform: translateY(2px);
      box-shadow: 0 0px 0 var(--border-color);
    }

    .pinyin-text {
      font-size: 24px;
      font-weight: 800;
      color: var(--secondary-color);
    }

    .learn-count {
      font-size: 12px;
      font-weight: 800;
      color: #afafaf;
    }

    @media (max-width: 480px) {
      .pinyin-list {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="initialsSection"></div>
  <div id="finalsSection"></div>
</div>

<script>
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

const initials = [
  "b", "p", "m", "f", "d", "t", "n", "l", "g", "k", "h",
  "j", "q", "x", "zh", "ch", "sh", "r", "z", "c", "s", "y", "w"
];

const finals = [
  "a", "o", "e", "i", "u", "√º", "er",
  "ai", "ei", "ao", "ou", "an", "en", "ang", "eng", "ong",
  "ia", "ie", "iao", "iu", "ian", "in", "iang", "ing", "iong",
  "ua", "uo", "uai", "ui", "uan", "un", "uang", "ueng",
  "√ºe", "√ºan", "√ºn"
];

const pinyinExamples = {
  'b': 'ÂÖ´', 'p': 'Ê≥°', 'm': 'Â¶à', 'f': '‰Ωõ', 'd': 'Â§ß', 't': '‰ªñ', 'n': '‰Ω†', 'l': 'Êù•', 'g': 'Âì•', 'k': 'Âç°', 'h': 'Âëµ',
  'j': 'È∏°', 'q': '‰∏É', 'x': 'Ë•ø', 'zh': 'Áü•', 'ch': 'ÂêÉ', 'sh': 'ËØó', 'r': 'Êó•', 'z': 'Â≠ê', 'c': 'Ê¨°', 's': 'ÊÄù', 'y': 'ÁÉü', 'w': '‰∫î',
  'a': 'Âïä', 'o': 'Âì¶', 'e': 'ÂëÉ', 'i': 'Ë°£', 'u': '‰πå', '√º': 'Â•≥', 'er': 'ÂÑø', 'ai': 'Áà±', 'ei': 'Ê¨∏', 'ao': 'ÁÜ¨', 'ou': 'Ê¨ß', 'an': 'ÂÆâ',
  'en': 'ÊÅ©', 'ang': 'ÊòÇ', 'eng': 'ÂóØ', 'ong': 'Âó°', 'ia': 'ÂëÄ', 'ie': 'ËÄ∂', 'iao': 'ËÖ∞', 'iu': 'Ê≤π', 'ian': 'ÁÉü', 'in': 'Âõ†', 'iang': 'Â§Æ',
  'ing': 'Ëã±', 'iong': 'Áî®', 'ua': 'Ëõô', 'uo': 'Êàë', 'uai': 'Ê≠™', 'ui': 'Â®Å', 'uan': 'ÂºØ', 'un': 'Ê∏©', 'uang': 'Áéã', 'ueng': 'ÁøÅ', '√ºe': 'Á∫¶',
  '√ºan': 'ÂÜ§', '√ºn': 'Êôï'
};

function speakPinyin(py) {
  const example = pinyinExamples[py];
  if (!example) return;
  
  if (window.parent && window.parent.speak) {
    window.parent.speak(example, 'pinyin');
  } else {
    const u = new SpeechSynthesisUtterance(example);
    u.lang = "zh-CN";
    u.rate = 0.8;
    speechSynthesis.speak(u);
  }
}

function recordLearn(py, type) {
  if (!currentUser) return;
  fetch("/api/pinyin-learn", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUser.user_id, pinyin: py, type: type })
  }).catch(err => console.error(err));
}

function createPinyinButton(py, type, learnCount) {
  const btn = document.createElement("button");
  btn.className = "pinyin-btn";
  btn.innerHTML = `
    <span class="pinyin-text">${py}</span>
    <span class="learn-count">üîä ${learnCount || 0}</span>
  `;
  
  btn.onclick = () => {
    speakPinyin(py);
    recordLearn(py, type);
    const countSpan = btn.querySelector(".learn-count");
    const currentCount = parseInt(countSpan.textContent.match(/\d+/)[0]);
    countSpan.textContent = `üîä ${currentCount + 1}`;
  };
  
  return btn;
}

async function loadPinyinPage() {
  if (!currentUser) return;

  try {
    const res = await fetch(`/api/pinyin/${currentUser.user_id}`);
    let data = await res.json();

    if (data.length === 0) {
      await fetch("/api/pinyin-init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentUser.user_id })
      });
      loadPinyinPage();
      return;
    }

    const learnMap = {};
    data.forEach(item => { learnMap[`${item.type}:${item.pinyin}`] = item.learn_count || 0; });

    const initialsSection = document.getElementById("initialsSection");
    initialsSection.innerHTML = '<div class="section-title">Â£∞ÊØç</div>';
    const initialsList = document.createElement("div");
    initialsList.className = "pinyin-list";
    initials.forEach(py => initialsList.appendChild(createPinyinButton(py, "initial", learnMap[`initial:${py}`])));
    initialsSection.appendChild(initialsList);

    const finalsSection = document.getElementById("finalsSection");
    finalsSection.innerHTML = '<div class="section-title">ÈüµÊØç</div>';
    const finalsList = document.createElement("div");
    finalsList.className = "pinyin-list";
    finals.forEach(py => finalsList.appendChild(createPinyinButton(py, "final", learnMap[`final:${py}`])));
    finalsSection.appendChild(finalsList);
  } catch (err) {
    console.error(err);
  }
}

loadPinyinPage();
</script>
</body>
</html>
