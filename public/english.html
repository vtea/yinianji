<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±è¯­ - è¯æ±‡å­¦ä¹ </title>
  <!-- Tailwind CSS -->
  <link href="/output.css?v=4.0.0" rel="stylesheet">
  <style>
    /* åªä¿ç•™ Tailwind æ— æ³•å®ç°çš„ç‰¹æ®Šæ ·å¼ */
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
    }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
    }

    /* äº¤äº’åŠ¨ç”» - level-btnå’Œvocab-btnæ ·å¼å·²ç§»è‡³styles.css */

    .word-card {
      transition: all 0.2s;
    }

    .word-card:hover {
      background-color: #f7f7f7;
      transform: translateY(-2px);
    }

    .word-card:active {
      transform: translateY(2px);
      box-shadow: 0 0px 0 var(--border-color);
    }

    .word-card.learned {
      border-color: var(--primary-color);
      background: #f7fff0;
      box-shadow: 0 4px 0 var(--primary-color);
    }

    /* éŸ³æ ‡æ˜¾ç¤ºäº¤äº’ */
    .word-phonetic {
      display: none;
      transition: all 0.3s;
      pointer-events: none;
    }
    
    .word-phonetic.show {
      display: inline-block !important;
    }

    /* ä¸­æ–‡æ˜¾ç¤ºäº¤äº’ */
    .word-chinese {
      transition: opacity 0.2s;
    }

    .word-card:hover .word-chinese,
    .word-card.learned .word-chinese {
      opacity: 1;
    }

    /* æ·»åŠ æŒ‰é’®çŠ¶æ€ - æ ·å¼å·²ç§»è‡³styles.css */
  </style>
</head>
<body>
<div class="container">
  <div class="level-selector" id="levelSelector"></div>
  <div id="contentArea"></div>
</div>

<script>
// å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
let currentUser = null;
try {
  const userStr = localStorage.getItem("currentUser");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
} catch (err) {
  console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š", err);
  currentUser = null;
}

let userVocab = new Set();
let currentLevel = 'beginner';

// ä¿å­˜å·²æ˜¾ç¤ºçš„éŸ³æ ‡çŠ¶æ€
let shownPhoneticSet = new Set();

// è‹±è¯­è¯æ±‡åº“
const englishVocabulary = {
  'beginner': {
    name: 'å°ç™½å…¥é—¨',
    words: [
      { english: 'hello', phonetic: '/hÉ™ËˆloÊŠ/', chinese: 'ä½ å¥½' },
      { english: 'goodbye', phonetic: '/É¡ÊŠdËˆbaÉª/', chinese: 'å†è§' },
      { english: 'yes', phonetic: '/jÉ›s/', chinese: 'æ˜¯çš„' },
      { english: 'no', phonetic: '/noÊŠ/', chinese: 'ä¸æ˜¯' },
      { english: 'please', phonetic: '/pliËz/', chinese: 'è¯·' },
      { english: 'thank you', phonetic: '/Î¸Ã¦Å‹k juË/', chinese: 'è°¢è°¢ä½ ' },
      { english: 'sorry', phonetic: '/ËˆsÉ‘Ëri/', chinese: 'å¯¹ä¸èµ·' },
      { english: 'ok', phonetic: '/ËŒoÊŠËˆkeÉª/', chinese: 'å¥½çš„' },
      { english: 'my', phonetic: '/maÉª/', chinese: 'æˆ‘çš„' },
      { english: 'you', phonetic: '/juË/', chinese: 'ä½ ' },
      { english: 'he', phonetic: '/hiË/', chinese: 'ä»–' },
      { english: 'she', phonetic: '/ÊƒiË/', chinese: 'å¥¹' },
      { english: 'mom', phonetic: '/mÉ‘Ëm/', chinese: 'å¦ˆå¦ˆ' },
      { english: 'dad', phonetic: '/dÃ¦d/', chinese: 'çˆ¸çˆ¸' },
      { english: 'apple', phonetic: '/ËˆÃ¦pl/', chinese: 'è‹¹æœ' },
      { english: 'cat', phonetic: '/kÃ¦t/', chinese: 'çŒ«' },
      { english: 'dog', phonetic: '/dÉ”ËÉ¡/', chinese: 'ç‹—' },
      { english: 'sun', phonetic: '/sÊŒn/', chinese: 'å¤ªé˜³' },
      { english: 'moon', phonetic: '/muËn/', chinese: 'æœˆäº®' },
      { english: 'water', phonetic: '/ËˆwÉ”ËtÉ™r/', chinese: 'æ°´' },
    ]
  },
  'grade1': {
    name: '1å¹´çº§',
    words: [
      { english: 'book', phonetic: '/bÊŠk/', chinese: 'ä¹¦' },
      { english: 'pen', phonetic: '/pÉ›n/', chinese: 'ç¬”' },
      { english: 'pencil', phonetic: '/ËˆpÉ›nsl/', chinese: 'é“…ç¬”' },
      { english: 'table', phonetic: '/ËˆteÉªbl/', chinese: 'æ¡Œå­' },
      { english: 'chair', phonetic: '/tÊƒÉ›r/', chinese: 'æ¤…å­' },
      { english: 'room', phonetic: '/ruËm/', chinese: 'æˆ¿é—´' },
      { english: 'school', phonetic: '/skuËl/', chinese: 'å­¦æ ¡' },
      { english: 'teacher', phonetic: '/ËˆtiËtÊƒÉ™r/', chinese: 'è€å¸ˆ' },
      { english: 'student', phonetic: '/ËˆstuËdÉ™nt/', chinese: 'å­¦ç”Ÿ' },
      { english: 'friend', phonetic: '/frÉ›nd/', chinese: 'æœ‹å‹' },
      { english: 'red', phonetic: '/rÉ›d/', chinese: 'çº¢è‰²' },
      { english: 'blue', phonetic: '/bluË/', chinese: 'è“è‰²' },
      { english: 'green', phonetic: '/É¡riËn/', chinese: 'ç»¿è‰²' },
      { english: 'yellow', phonetic: '/ËˆjÉ›loÊŠ/', chinese: 'é»„è‰²' },
      { english: 'big', phonetic: '/bÉªÉ¡/', chinese: 'å¤§çš„' },
      { english: 'small', phonetic: '/smÉ”Ël/', chinese: 'å°çš„' },
      { english: 'one', phonetic: '/wÊŒn/', chinese: 'ä¸€' },
      { english: 'two', phonetic: '/tuË/', chinese: 'äºŒ' },
      { english: 'three', phonetic: '/Î¸riË/', chinese: 'ä¸‰' },
      { english: 'four', phonetic: '/fÉ”Ër/', chinese: 'å››' },
      { english: 'five', phonetic: '/faÉªv/', chinese: 'äº”' },
      { english: 'good', phonetic: '/É¡ÊŠd/', chinese: 'å¥½çš„' },
      { english: 'bad', phonetic: '/bÃ¦d/', chinese: 'åçš„' },
      { english: 'happy', phonetic: '/ËˆhÃ¦pi/', chinese: 'å¿«ä¹çš„' },
      { english: 'sad', phonetic: '/sÃ¦d/', chinese: 'ä¼¤å¿ƒçš„' },
    ]
  },
  'grade2': {
    name: '2å¹´çº§',
    words: [
      { english: 'bread', phonetic: '/brÉ›d/', chinese: 'é¢åŒ…' },
      { english: 'milk', phonetic: '/mÉªlk/', chinese: 'ç‰›å¥¶' },
      { english: 'rice', phonetic: '/raÉªs/', chinese: 'ç±³é¥­' },
      { english: 'chicken', phonetic: '/ËˆtÊƒÉªkÉ™n/', chinese: 'é¸¡è‚‰' },
      { english: 'fish', phonetic: '/fÉªÊƒ/', chinese: 'é±¼' },
      { english: 'egg', phonetic: '/É›É¡/', chinese: 'é¸¡è›‹' },
      { english: 'orange', phonetic: '/ËˆÉ”ËrÉªndÊ’/', chinese: 'æ©™å­' },
      { english: 'banana', phonetic: '/bÉ™ËˆnÃ¦nÉ™/', chinese: 'é¦™è•‰' },
      { english: 'strawberry', phonetic: '/ËˆstrÉ”ËbÉ›ri/', chinese: 'è‰è“' },
      { english: 'flower', phonetic: '/ËˆflaÊŠÉ™r/', chinese: 'èŠ±' },
      { english: 'tree', phonetic: '/triË/', chinese: 'æ ‘' },
      { english: 'grass', phonetic: '/É¡rÃ¦s/', chinese: 'è‰' },
      { english: 'sky', phonetic: '/skaÉª/', chinese: 'å¤©ç©º' },
      { english: 'rain', phonetic: '/reÉªn/', chinese: 'é›¨' },
      { english: 'snow', phonetic: '/snoÊŠ/', chinese: 'é›ª' },
      { english: 'wind', phonetic: '/wÉªnd/', chinese: 'é£' },
      { english: 'cloud', phonetic: '/klaÊŠd/', chinese: 'äº‘' },
      { english: 'star', phonetic: '/stÉ‘Ër/', chinese: 'æ˜Ÿæ˜Ÿ' },
      { english: 'bird', phonetic: '/bÉœËrd/', chinese: 'é¸Ÿ' },
      { english: 'pig', phonetic: '/pÉªÉ¡/', chinese: 'çŒª' },
      { english: 'cow', phonetic: '/kaÊŠ/', chinese: 'ç‰›' },
      { english: 'horse', phonetic: '/hÉ”Ërs/', chinese: 'é©¬' },
      { english: 'run', phonetic: '/rÊŒn/', chinese: 'è·‘' },
      { english: 'walk', phonetic: '/wÉ”Ëk/', chinese: 'èµ°' },
      { english: 'jump', phonetic: '/dÊ’ÊŒmp/', chinese: 'è·³' },
    ]
  },
  'grade3': {
    name: '3å¹´çº§',
    words: [
      { english: 'computer', phonetic: '/kÉ™mËˆpjuËtÉ™r/', chinese: 'ç”µè„‘' },
      { english: 'telephone', phonetic: '/ËˆtÉ›lÉªfoÊŠn/', chinese: 'ç”µè¯' },
      { english: 'bicycle', phonetic: '/ËˆbaÉªsÉªkl/', chinese: 'è‡ªè¡Œè½¦' },
      { english: 'car', phonetic: '/kÉ‘Ër/', chinese: 'æ±½è½¦' },
      { english: 'bus', phonetic: '/bÊŒs/', chinese: 'å…¬äº¤è½¦' },
      { english: 'train', phonetic: '/treÉªn/', chinese: 'ç«è½¦' },
      { english: 'plane', phonetic: '/pleÉªn/', chinese: 'é£æœº' },
      { english: 'ship', phonetic: '/ÊƒÉªp/', chinese: 'èˆ¹' },
      { english: 'road', phonetic: '/roÊŠd/', chinese: 'é“è·¯' },
      { english: 'bridge', phonetic: '/brÉªdÊ’/', chinese: 'æ¡¥' },
      { english: 'building', phonetic: '/ËˆbÉªldÉªÅ‹/', chinese: 'å»ºç­‘ç‰©' },
      { english: 'hospital', phonetic: '/ËˆhÉ‘ËspÉªtl/', chinese: 'åŒ»é™¢' },
      { english: 'library', phonetic: '/ËˆlaÉªbrÉ›ri/', chinese: 'å›¾ä¹¦é¦†' },
      { english: 'restaurant', phonetic: '/ËˆrÉ›stÉ™rÉ‘Ënt/', chinese: 'é¤å…' },
      { english: 'market', phonetic: '/ËˆmÉ‘ËrkÉªt/', chinese: 'å¸‚åœº' },
      { english: 'park', phonetic: '/pÉ‘Ërk/', chinese: 'å…¬å›­' },
      { english: 'beach', phonetic: '/biËtÊƒ/', chinese: 'æµ·æ»©' },
      { english: 'mountain', phonetic: '/ËˆmaÊŠntÉ™n/', chinese: 'å±±' },
      { english: 'river', phonetic: '/ËˆrÉªvÉ™r/', chinese: 'æ²³' },
      { english: 'lake', phonetic: '/leÉªk/', chinese: 'æ¹–' },
      { english: 'morning', phonetic: '/ËˆmÉ”ËrnÉªÅ‹/', chinese: 'æ—©ä¸Š' },
      { english: 'afternoon', phonetic: '/ËŒÃ¦ftÉ™rËˆnuËn/', chinese: 'ä¸‹åˆ' },
      { english: 'night', phonetic: '/naÉªt/', chinese: 'æ™šä¸Š' },
      { english: 'winter', phonetic: '/ËˆwÉªntÉ™r/', chinese: 'å†¬å¤©' },
      { english: 'summer', phonetic: '/ËˆsÊŒmÉ™r/', chinese: 'å¤å¤©' },
      { english: 'spring', phonetic: '/sprÉªÅ‹/', chinese: 'æ˜¥å¤©' },
      { english: 'autumn', phonetic: '/ËˆÉ”ËtÉ™m/', chinese: 'ç§‹å¤©' },
    ]
  }
};

async function loadUserVocab() {
  if (!currentUser) {
    renderLevel(currentLevel);
    return;
  }
  try {
    const res = await fetch(`/api/english-new-words/${currentUser.user_id}`);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const words = await res.json();
    
    if (!Array.isArray(words)) {
      userVocab = new Set();
    } else {
      userVocab = new Set(words.map(w => w.word));
    }
    
    renderLevel(currentLevel);
  } catch (err) {
    console.error("åŠ è½½å•è¯æœ¬å¤±è´¥ï¼š", err);
    userVocab = new Set();
    renderLevel(currentLevel);
  }
}

async function toggleVocab(event, wordObj) {
  event.stopPropagation();
  if (!currentUser) return alert("è¯·å…ˆç™»å½•");
  
  const isAdding = !userVocab.has(wordObj.english);
  const url = "/api/english-new-words";
  const method = isAdding ? "POST" : "DELETE";

  try {
    const res = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        user_id: currentUser.user_id, 
        word: wordObj.english,
        phonetic: wordObj.phonetic,
        chinese: wordObj.chinese
      })
    });
    
    if (res.ok) {
      if (isAdding) {
        const data = await res.json().catch(() => null);
        if (data && data.prevDeleted) {
          const addedAt = data.prevDeleted.added_at ? new Date(data.prevDeleted.added_at).toLocaleDateString() : "æœªçŸ¥";
          const count = data.prevDeleted.play_count || 0;
          alert(`æç¤ºï¼šè¿™ä¸ªå•è¯ä»¥å‰æ·»åŠ è¿‡ã€‚\næ·»åŠ æ—¶é—´ï¼š${addedAt}\næœ—è¯»æ¬¡æ•°ï¼š${count}`);
        }
      }
      loadUserVocab();
      if (window.parent && window.parent.updateWordStats) {
        window.parent.updateWordStats();
      }
    }
  } catch (err) {
    console.error("æ“ä½œå¤±è´¥ï¼š", err);
  }
}

function speakWord(english) {
  if (!english) return;
  if (window.parent && window.parent.speak) {
    window.parent.speak(english, 'english');
  } else {
    const saved = localStorage.getItem("voiceSettings");
    const voiceSettings = saved ? JSON.parse(saved) : { rate: 0.8 };
    const u = new SpeechSynthesisUtterance(english);
    u.lang = "en-US";
    u.rate = voiceSettings.rate;
    speechSynthesis.cancel();
    setTimeout(() => {
      speechSynthesis.speak(u);
    }, 50);
  }

}

function recordLearn(english) {
  if (!currentUser) return;
  fetch("/api/english-learn", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      user_id: currentUser.user_id, 
      word: english,
      level: currentLevel
    })
  }).catch(err => console.error("è®°å½•å¤±è´¥ï¼š", err));
}

function createWordCard(wordObj, learnCount = 0) {
  const isInVocab = userVocab.has(wordObj.english);
  const card = document.createElement("div");
  card.className = "word-card" + (learnCount > 0 ? " learned" : "");
  card.innerHTML = `
    <button class="add-vocab-btn ${isInVocab ? 'active' : ''}" onclick="toggleVocab(event, ${JSON.stringify(wordObj).replace(/"/g, '&quot;')})">ğŸ“–</button>
    <div class="word-content-wrapper">
      <div class="word-english">${wordObj.english}</div>
      <div class="word-phonetic" data-phonetic="${wordObj.phonetic || ''}">${wordObj.phonetic || ''}</div>
    </div>
    <div class="word-chinese">${wordObj.chinese || ''}</div>
    <div class="learn-count">ğŸ”Š ${learnCount}</div>
  `;
  
  const phoneticEl = card.querySelector(".word-phonetic");
  const addVocabBtn = card.querySelector(".add-vocab-btn");
  
  // æ¢å¤ä¹‹å‰æ˜¾ç¤ºçš„éŸ³æ ‡çŠ¶æ€
  if (phoneticEl && shownPhoneticSet.has(wordObj.english)) {
    phoneticEl.classList.add('show');
    phoneticEl.style.display = 'inline-block';
    phoneticEl.style.backgroundColor = '#e3f2fd';
    phoneticEl.style.color = '#1976d2';
  }
  
  // ç‚¹å‡»å¡ç‰‡æœ—è¯»ã€æ˜¾ç¤ºéŸ³æ ‡å’Œè®°å½•å­¦ä¹ 
  card.addEventListener('click', function(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æ·»åŠ æŒ‰é’®ï¼Œä¸æ‰§è¡Œå…¶ä»–æ“ä½œ
    if (e.target.classList.contains('add-vocab-btn') || 
        e.target.closest('.add-vocab-btn')) {
      return;
    }
    
    // æ˜¾ç¤ºéŸ³æ ‡ï¼ˆä¸€ç›´æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨éšè—ï¼‰
    const currentPhoneticEl = card.querySelector(".word-phonetic");
    
    if (currentPhoneticEl) {
      // ç¡®ä¿éŸ³æ ‡æœ‰å†…å®¹
      const phoneticText = currentPhoneticEl.getAttribute('data-phonetic') || wordObj.phonetic || '';
      if (phoneticText) {
        currentPhoneticEl.textContent = phoneticText;
      }
      
      // ç›´æ¥æ˜¾ç¤º - ä½¿ç”¨displayæ§åˆ¶
      currentPhoneticEl.classList.add('show');
      currentPhoneticEl.style.display = 'inline-block';
      currentPhoneticEl.style.backgroundColor = '#e3f2fd';
      currentPhoneticEl.style.color = '#1976d2';
      
      // ä¿å­˜åˆ°å·²æ˜¾ç¤ºé›†åˆ
      shownPhoneticSet.add(wordObj.english);
    }
    
    // æœ—è¯»å’Œè®°å½•å­¦ä¹ 
    speakWord(wordObj.english);
    recordLearn(wordObj.english);
    card.classList.add("learned");
    const countEl = card.querySelector(".learn-count");
    const countMatch = countEl.textContent.match(/\d+/);
    const count = countMatch ? parseInt(countMatch[0]) : 0;
    countEl.textContent = `ğŸ”Š ${count + 1}`;
  });
  
  return card;
}

function renderLevel(level) {
  currentLevel = level;
  const data = englishVocabulary[level];
  const contentArea = document.getElementById("contentArea");
  
  contentArea.innerHTML = `
    <div class="section-title">${data.name}</div>
    <div class="word-list" id="wordList"></div>
  `;
  
  const wordList = document.getElementById("wordList");
  data.words.forEach(word => {
    wordList.appendChild(createWordCard(word, 0));
  });

  fetchMissingPhonetics();
}

async function fetchMissingPhonetics() {
  const cards = document.querySelectorAll(".word-card");
  for (const card of cards) {
    const phoneticEl = card.querySelector(".word-phonetic");
    const english = card.querySelector(".word-english").textContent;
    
    if (!phoneticEl.textContent || phoneticEl.textContent === "undefined") {
      try {
        const res = await fetch(`/api/proxy/english/${english}`);
        const data = await res.json();
        if (data.phonetic) {
          phoneticEl.textContent = data.phonetic;
        }
      } catch (err) {
        console.error(`è·å– ${english} éŸ³æ ‡å¤±è´¥`, err);
      }
    }
  }
}

function initLevelSelector() {
  const selector = document.getElementById("levelSelector");
  selector.innerHTML = '';
  Object.keys(englishVocabulary).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "level-btn" + (key === currentLevel ? " active" : "");
    btn.textContent = englishVocabulary[key].name;
    btn.onclick = () => {
      currentLevel = key;
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderLevel(key);
    };
    selector.appendChild(btn);
  });

  const vocabBtn = document.createElement("button");
  vocabBtn.className = "vocab-btn";
  vocabBtn.textContent = "ğŸ“– å•è¯æœ¬";
  vocabBtn.onclick = () => window.location.href = "vocabulary.html";
  selector.appendChild(vocabBtn);
}

// åˆå§‹åŒ–
if (currentUser) {
  initLevelSelector();
  loadUserVocab();
} else {
  initLevelSelector();
  renderLevel('beginner');
  document.getElementById("contentArea").innerHTML = '<div class="empty-message">è¯·å…ˆç™»å½•</div>';
}
</script>
</body>
</html>
