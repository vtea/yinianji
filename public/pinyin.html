<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å£°æ¯éŸµæ¯ - æ‹¼éŸ³å­¦ä¹ </title>
  <!-- Tailwind CSS -->
  <link href="/output.css?v=4.0.0" rel="stylesheet">
  <style>
    /* åªä¿ç•™ Tailwind æ— æ³•å®ç°çš„ç‰¹æ®Šæ ·å¼ */
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --secondary-color: #1cb0f6;
      --accent-color: #ffc800;
      --text-color: #4b4b4b;
      --border-color: #e5e5e5;
    }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
    }

    /* æ‹¼éŸ³æŒ‰é’®æ ·å¼å·²ç§»è‡³styles.css */
  </style>
</head>
<body>
<div class="container">
  <div id="initialsSection"></div>
  <div id="finalsSection"></div>
</div>

<script>
// å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
let currentUser = null;
try {
  const userStr = localStorage.getItem("currentUser");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
} catch (err) {
  console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š", err);
  currentUser = null;
}

const initials = [
  "b", "p", "m", "f", "d", "t", "n", "l", "g", "k", "h",
  "j", "q", "x", "zh", "ch", "sh", "r", "z", "c", "s", "y", "w"
];

const finals = [
  "a", "o", "e", "i", "u", "Ã¼", "er",
  "ai", "ei", "ao", "ou", "an", "en", "ang", "eng", "ong",
  "ia", "ie", "iao", "iu", "ian", "in", "iang", "ing", "iong",
  "ua", "uo", "uai", "ui", "uan", "un", "uang", "ueng",
  "Ã¼e", "Ã¼an", "Ã¼n"
];

const pinyinExamples = {
  'b': 'å…«', 'p': 'æ³¡', 'm': 'å¦ˆ', 'f': 'ä½›', 'd': 'å¤§', 't': 'ä»–', 'n': 'ä½ ', 'l': 'æ¥', 'g': 'å“¥', 'k': 'å¡', 'h': 'å‘µ',
  'j': 'é¸¡', 'q': 'ä¸ƒ', 'x': 'è¥¿', 'zh': 'çŸ¥', 'ch': 'åƒ', 'sh': 'è¯—', 'r': 'æ—¥', 'z': 'å­', 'c': 'æ¬¡', 's': 'æ€', 'y': 'çƒŸ', 'w': 'äº”',
  'a': 'å•Š', 'o': 'å“¦', 'e': 'å‘ƒ', 'i': 'è¡£', 'u': 'ä¹Œ', 'Ã¼': 'å¥³', 'er': 'å„¿', 'ai': 'çˆ±', 'ei': 'æ¬¸', 'ao': 'ç†¬', 'ou': 'æ¬§', 'an': 'å®‰',
  'en': 'æ©', 'ang': 'æ˜‚', 'eng': 'å—¯', 'ong': 'å—¡', 'ia': 'å‘€', 'ie': 'è€¶', 'iao': 'è…°', 'iu': 'æ²¹', 'ian': 'çƒŸ', 'in': 'å› ', 'iang': 'å¤®',
  'ing': 'è‹±', 'iong': 'ç”¨', 'ua': 'è›™', 'uo': 'æˆ‘', 'uai': 'æ­ª', 'ui': 'å¨', 'uan': 'å¼¯', 'un': 'æ¸©', 'uang': 'ç‹', 'ueng': 'ç¿', 'Ã¼e': 'çº¦',
  'Ã¼an': 'å†¤', 'Ã¼n': 'æ™•'
};

function speakPinyin(py) {
  const example = pinyinExamples[py];
  if (!example) return;
  
  if (window.parent && window.parent.speak) {
    window.parent.speak(example, 'pinyin');
  } else {
    const u = new SpeechSynthesisUtterance(example);
    u.lang = "zh-CN";
    u.rate = 0.8;
    speechSynthesis.speak(u);
  }
}

function recordLearn(py, type) {
  if (!currentUser) return;
  fetch("/api/pinyin-learn", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUser.user_id, pinyin: py, type: type })
  }).catch(err => console.error(err));
}

function createPinyinButton(py, type, learnCount) {
  const btn = document.createElement("button");
  btn.className = "pinyin-btn";
  btn.innerHTML = `
    <span class="pinyin-text">${py}</span>
    <span class="learn-count">ğŸ”Š ${learnCount || 0}</span>
  `;
  
  btn.onclick = () => {
    speakPinyin(py);
    recordLearn(py, type);
    const countSpan = btn.querySelector(".learn-count");
    if (countSpan) {
      const match = countSpan.textContent.match(/\d+/);
      const currentCount = match ? parseInt(match[0]) : 0;
      countSpan.textContent = `ğŸ”Š ${currentCount + 1}`;
    }
  };
  
  return btn;
}

async function loadPinyinPage() {
  const initialsSection = document.getElementById("initialsSection");
  const finalsSection = document.getElementById("finalsSection");
  
  if (!initialsSection || !finalsSection) {
    console.error("æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ");
    return;
  }

  // åˆå§‹åŒ–å­¦ä¹ æ¬¡æ•°æ˜ å°„
  let learnMap = {};

  if (currentUser) {
    try {
      const res = await fetch(`/api/pinyin/${currentUser.user_id}`);
      
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      
      let data = await res.json();

      if (!Array.isArray(data)) {
        data = [];
      }

      if (data.length === 0) {
        await fetch("/api/pinyin-init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: currentUser.user_id })
        });
        loadPinyinPage();
        return;
      }

      data.forEach(item => { 
        learnMap[`${item.type}:${item.pinyin}`] = item.learn_count || 0; 
      });
    } catch (err) {
      console.error("åŠ è½½æ‹¼éŸ³å­¦ä¹ è®°å½•å¤±è´¥ï¼š", err);
      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæ‹¼éŸ³è¡¨ï¼ˆå­¦ä¹ æ¬¡æ•°ä¸º0ï¼‰
    }
  }

  // æ¸²æŸ“å£°æ¯
  initialsSection.innerHTML = '<div class="section-title">å£°æ¯</div>';
  const initialsList = document.createElement("div");
  initialsList.className = "pinyin-list";
  initials.forEach(py => initialsList.appendChild(createPinyinButton(py, "initial", learnMap[`initial:${py}`])));
  initialsSection.appendChild(initialsList);

  // æ¸²æŸ“éŸµæ¯
  finalsSection.innerHTML = '<div class="section-title">éŸµæ¯</div>';
  const finalsList = document.createElement("div");
  finalsList.className = "pinyin-list";
  finals.forEach(py => finalsList.appendChild(createPinyinButton(py, "final", learnMap[`final:${py}`])));
  finalsSection.appendChild(finalsList);
}

loadPinyinPage();
</script>
</body>
</html>
