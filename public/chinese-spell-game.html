<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>æ‹¼å†™æ¸¸æˆ - ç”Ÿå­—å­¦ä¹ </title>
  <style>
    :root {
      --primary-color: #58cc02;
      --primary-hover: #46a302;
      --primary-gradient: linear-gradient(180deg, #58cc02 0%, #46a302 100%);
      --secondary-color: #1cb0f6;
      --secondary-gradient: linear-gradient(180deg, #1cb0f6 0%, #0e8ac7 100%);
      --accent-color: #ffc800;
      --accent-gradient: linear-gradient(180deg, #ffd700 0%, #ffc800 100%);
      --text-color: #3c3c3c;
      --border-color: #e5e5e5;
      --error-color: #ff4b4b;
      --error-gradient: linear-gradient(180deg, #ff6b6b 0%, #ff4b4b 100%);
      --success-color: #58cc02;
      --success-gradient: linear-gradient(180deg, #6dd802 0%, #58cc02 100%);
      --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      --hover-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: var(--text-color);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ï¼Œè€ƒè™‘æµè§ˆå™¨å·¥å…·æ  */
      overflow-x: hidden;
      /* å®‰å…¨åŒºåŸŸé€‚é…ï¼Œé¿å…è¢«æµè§ˆå™¨æ é®æŒ¡ */
      padding-bottom: env(safe-area-inset-bottom);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      min-height: 100dvh;
      gap: 16px;
    }

    /* iPadæ¨ªå±å’Œå¤§å¹³æ¿ */
    @media (max-width: 1024px) and (min-width: 769px) {
      .container {
        padding: 20px;
      }
    }

    /* iPadç«–å±å’Œå°å¹³æ¿ */
    @media (max-width: 768px) and (min-width: 601px) {
      .container {
        padding: 16px;
      }
    }

    /* å¤§æ‰‹æœº */
    @media (max-width: 600px) and (min-width: 481px) {
      .container {
        padding: 12px;
      }
    }

    /* å°æ‰‹æœº */
    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
    }

    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      box-shadow: var(--card-shadow);
    }

    .header-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary-color);
    }

    .score-info {
      display: flex;
      gap: 16px;
      font-weight: 800;
      font-size: 16px;
    }

    /* iPadæ¨ªå±å’Œå¤§å¹³æ¿ */
    @media (max-width: 1024px) and (min-width: 769px) {
      .header {
        padding: 18px;
        margin-bottom: 20px;
        border-radius: 20px;
      }
      .header-title {
        font-size: 22px;
      }
      .score-info {
        font-size: 15px;
        gap: 14px;
      }
    }

    /* iPadç«–å±å’Œå°å¹³æ¿ */
    @media (max-width: 768px) and (min-width: 601px) {
      .header {
        padding: 16px;
        margin-bottom: 18px;
        border-radius: 18px;
      }
      .header-title {
        font-size: 20px;
      }
      .score-info {
        font-size: 14px;
        gap: 12px;
      }
    }

    /* å¤§æ‰‹æœº */
    @media (max-width: 600px) and (min-width: 481px) {
      .header {
        padding: 14px;
        margin-bottom: 14px;
        border-radius: 14px;
      }
      .header-title {
        font-size: 19px;
      }
      .score-info {
        font-size: 13px;
        gap: 10px;
      }
    }

    /* å°æ‰‹æœº */
    @media (max-width: 480px) {
      .header {
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 12px;
      }
      .header-title {
        font-size: 18px;
      }
      .score-info {
        font-size: 12px;
        gap: 8px;
      }
    }

    .score-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .game-area {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 24px;
      padding: 24px;
      min-height: 400px;
      box-shadow: var(--card-shadow);
      transition: box-shadow 0.3s ease;
    }

    .game-area:hover {
      box-shadow: var(--hover-shadow);
    }

    /* iPadæ¨ªå±å’Œå¤§å¹³æ¿ */
    @media (max-width: 1024px) and (min-width: 769px) {
      .game-area {
        padding: 20px;
        border-radius: 20px;
        min-height: 380px;
      }
    }

    /* iPadç«–å±å’Œå°å¹³æ¿ */
    @media (max-width: 768px) and (min-width: 601px) {
      .game-area {
        padding: 18px;
        border-radius: 18px;
        min-height: 350px;
      }
    }

    /* å¤§æ‰‹æœº */
    @media (max-width: 600px) and (min-width: 481px) {
      .game-area {
        padding: 14px;
        border-radius: 14px;
        min-height: 300px;
      }
    }

    /* å°æ‰‹æœº */
    @media (max-width: 480px) {
      .game-area {
        padding: 8px;
        border-radius: 12px;
        min-height: auto;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
    }

    .question-container {
      margin-bottom: 24px;
    }

    .question-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 16px;
      color: var(--text-color);
      text-align: center;
    }

    .pinyin-display {
      font-size: 32px;
      font-weight: 800;
      text-align: center;
      color: white;
      margin: 20px 0;
      padding: 24px;
      background: var(--secondary-gradient);
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(28, 176, 246, 0.3);
      letter-spacing: 2px;
      position: relative;
      overflow: hidden;
    }

    .pinyin-display::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 0.5; }
      50% { transform: translate(-30%, -30%) rotate(180deg); opacity: 0.8; }
    }

    @media (max-width: 768px) {
      .pinyin-display {
        font-size: 24px;
        margin: 16px 0;
        padding: 16px;
      }
    }

    @media (max-width: 480px) {
      .pinyin-display {
        font-size: 16px;
        margin: 6px 0;
        padding: 8px;
      }
    }

    .input-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 30px 0;
    }

    @media (max-width: 768px) {
      .input-area {
        gap: 16px;
        margin: 20px 0;
      }
    }

    @media (max-width: 480px) {
      .input-area {
        gap: 12px;
        margin: 12px 0;
      }
    }

    .input-box {
      width: 200px;
      height: 200px;
      border: none;
      border-radius: 24px;
      font-size: 120px;
      font-weight: 800;
      text-align: center;
      background: white;
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1), inset 0 0 0 3px var(--border-color);
      transition: all 0.3s ease;
    }

    .input-box:focus-within {
      box-shadow: 0 12px 32px rgba(28, 176, 246, 0.3), inset 0 0 0 3px var(--secondary-color);
      transform: scale(1.02);
    }

    @media (max-width: 768px) {
      .input-box {
        width: 150px;
        height: 150px;
        font-size: 90px;
      }
    }

    @media (max-width: 480px) {
      .input-box {
        width: 120px;
        height: 120px;
        font-size: 70px;
        border-width: 2px;
      }
    }

    .input-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        linear-gradient(#ddd 1px, transparent 1px),
        linear-gradient(90deg, #ddd 1px, transparent 1px),
        linear-gradient(45deg, #eee 1px, transparent 1px),
        linear-gradient(-45deg, #eee 1px, transparent 1px);
      background-size:
        100% 1px,
        1px 100%,
        100% 100%,
        100% 100%;
      background-position:
        center,
        center,
        center,
        center;
      background-repeat: no-repeat;
      pointer-events: none;
      z-index: 0;
    }

    .input-box input {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      font-size: 120px;
      font-weight: 800;
      text-align: center;
      color: var(--text-color);
      outline: none;
      z-index: 1;
      position: relative;
    }

    @media (max-width: 768px) {
      .input-box input {
        font-size: 90px;
      }
    }

    @media (max-width: 480px) {
      .input-box input {
        font-size: 70px;
      }
    }

    .input-box.correct {
      background: var(--success-gradient);
      color: white;
      box-shadow: 0 12px 32px rgba(88, 204, 2, 0.4);
      animation: correctBounce 0.6s ease;
    }

    .input-box.wrong {
      background: var(--error-gradient);
      color: white;
      box-shadow: 0 12px 32px rgba(255, 75, 75, 0.4);
      animation: wrongShake 0.6s ease;
    }

    @keyframes correctBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25%, 75% { transform: translateX(-10px) rotate(-3deg); }
      50% { transform: translateX(10px) rotate(3deg); }
    }

    /* å¹³æ¿ä¸“ç”¨ä¼˜åŒ– - ç´§å‡‘åˆç†å¸ƒå±€ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹å¯è§ */
    @media (min-width: 601px) and (max-width: 1024px) {
      .container {
        padding: 8px !important;
        gap: 8px !important;
        min-height: 100vh !important;
        min-height: 100dvh !important;
        grid-template-rows: auto 1fr !important;
      }

      .header {
        padding: 10px 12px !important;
        margin-bottom: 0 !important;
        border-radius: 12px !important;
      }

      .header-title {
        font-size: 18px !important;
      }

      .score-info {
        font-size: 13px !important;
        gap: 10px !important;
      }

      .game-area {
        padding: 12px !important;
        display: grid !important;
        grid-template-rows: auto auto auto 1fr auto !important;
        gap: 8px !important;
        min-height: 0 !important;
        max-height: 100% !important;
        overflow: visible !important;
      }
      
      .question-container {
        margin-bottom: 0 !important;
      }

      .question-title {
        font-size: 14px !important;
        margin-bottom: 6px !important;
        line-height: 1.3 !important;
      }

      .pinyin-display {
        font-size: 20px !important;
        padding: 10px 12px !important;
        margin: 4px 0 !important;
        border-radius: 12px !important;
      }
      
      .input-area {
        margin: 8px 0 !important;
        gap: 12px !important;
      }

      .input-box {
        width: 120px !important;
        height: 120px !important;
        font-size: 80px !important;
        border-radius: 12px !important;
      }

      .input-box input {
        font-size: 80px !important;
      }
      
      .controls {
        margin-top: 8px !important;
        margin-bottom: 0 !important;
        gap: 8px !important;
        padding-top: 4px !important;
        flex-direction: row !important;
      }

      .btn {
        padding: 8px 16px !important;
        font-size: 13px !important;
        border-radius: 10px !important;
        flex: 0 0 auto !important;
      }
    }

    .correct-answer {
      font-size: 24px;
      font-weight: 800;
      color: var(--success-color);
      margin-top: 12px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      margin-bottom: calc(20px + env(safe-area-inset-bottom));
    }

    @media (max-width: 768px) {
      .controls {
        margin-top: 20px;
        margin-bottom: calc(16px + env(safe-area-inset-bottom));
        gap: 12px;
      }
      .btn {
        padding: 12px 20px;
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      .controls {
        margin-top: 16px;
        margin-bottom: calc(12px + env(safe-area-inset-bottom));
        gap: 8px;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .btn {
        flex: 1;
        min-width: 120px;
        padding: 10px;
        font-size: 14px;
      }
    }

    .btn {
      padding: 16px 32px;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--border-color);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-hover);
      box-shadow: 0 4px 0 var(--primary-hover);
    }

    .btn-primary:active {
      transform: translateY(4px);
      box-shadow: 0 0 0;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: var(--text-color);
    }

    .btn-secondary:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--border-color);
    }

    .result-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .result-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 16px;
      color: var(--text-color);
    }

    .result-score {
      font-size: 48px;
      font-weight: 800;
      color: var(--primary-color);
      margin: 24px 0;
    }

    .result-details {
      font-size: 18px;
      color: #777;
      margin-bottom: 24px;
      line-height: 1.8;
    }

    .celebration {
      font-size: 64px;
      margin: 20px 0;
      animation: bounce 0.5s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .wrong-answers-section {
      margin: 24px 0;
      padding: 16px;
      background: #fff9e6;
      border-radius: 12px;
      text-align: left;
    }

    .wrong-answers-title {
      font-size: 16px;
      font-weight: 800;
      color: #ff8800;
      margin-bottom: 12px;
      text-align: center;
    }

    .wrong-answer-item {
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 2px solid #ffc107;
    }

    .wrong-answer-hanzi {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 6px;
      text-align: center;
    }

    .wrong-answer-info {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .wrong-answer-selected {
      color: #dc3545;
      margin-bottom: 4px;
    }

    .wrong-answer-correct {
      color: #28a745;
    }

    @media (max-width: 768px) {
      .result-screen {
        padding: 24px 16px;
      }

      .result-title {
        font-size: 24px;
        margin-bottom: 12px;
      }

      .result-score {
        font-size: 36px;
        margin: 16px 0;
      }

      .result-details {
        font-size: 15px;
        margin-bottom: 20px;
      }

      .celebration {
        font-size: 48px;
        margin: 12px 0;
      }

      .wrong-answers-section {
        margin: 20px 0;
        padding: 12px;
      }

      .wrong-answers-title {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .wrong-answer-item {
        margin-bottom: 10px;
        padding: 10px;
      }

      .wrong-answer-hanzi {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .wrong-answer-info {
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .result-screen {
        padding: 20px 12px;
      }

      .result-title {
        font-size: 20px;
        margin-bottom: 10px;
      }

      .result-score {
        font-size: 32px;
        margin: 12px 0;
      }

      .result-details {
        font-size: 14px;
        margin-bottom: 16px;
      }

      .celebration {
        font-size: 40px;
        margin: 10px 0;
      }

      .wrong-answers-section {
        margin: 16px 0;
        padding: 10px;
      }

      .wrong-answers-title {
        font-size: 13px;
        margin-bottom: 8px;
      }

      .wrong-answer-item {
        margin-bottom: 8px;
        padding: 8px;
      }

      .wrong-answer-hanzi {
        font-size: 18px;
        margin-bottom: 4px;
      }

      .wrong-answer-info {
        font-size: 11px;
      }
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 20px;
      font-weight: 800;
      color: #777;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .game-area {
        padding: 10px;
        min-height: auto;
        margin-bottom: calc(16px + env(safe-area-inset-bottom));
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px;
        margin-bottom: 10px;
      }
      .header-title {
        font-size: 16px;
      }
      .score-info {
        font-size: 12px;
        gap: 8px;
      }
      .question-title {
        font-size: 15px;
        margin-bottom: 8px;
      }
      .input-area {
        gap: 12px;
        margin: 12px 0;
      }
      .input-box {
        width: 130px;
        height: 130px;
        font-size: 80px;
        border-radius: 12px;
      }
      .input-box input {
        font-size: 80px;
        font-size: 60px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 6px;
        padding-bottom: calc(6px + env(safe-area-inset-bottom));
      }
      .header {
        padding: 8px 10px;
        margin-bottom: 8px;
      }
      .header-title {
        font-size: 14px;
      }
      .score-info {
        font-size: 10px;
        gap: 6px;
      }
      .game-area {
        padding: 6px;
        border-radius: 12px;
        min-height: auto;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        margin-bottom: 0;
      }
      .question-title {
        font-size: 12px;
        margin-bottom: 5px;
      }
      .question-container {
        margin-bottom: 8px;
      }
      .input-area {
        gap: 6px;
        margin: 6px 0;
      }
      .input-box {
        width: 100px;
        height: 100px;
        font-size: 60px;
        border-radius: 10px;
        border-width: 2px;
      }
      .input-box input {
        font-size: 60px;
      }
      .controls {
        margin-top: 10px;
        margin-bottom: 0;
        padding-bottom: max(60px, env(safe-area-inset-bottom));
      }
      .btn {
        padding: 10px;
        font-size: 13px;
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-title">âœï¸ æ‹¼å†™æ¸¸æˆ</div>
    <div class="score-info">
      <div class="score-item">
        <span>é¢˜ç›®:</span>
        <span id="currentQuestion">0</span>/<span id="totalQuestions">0</span>
      </div>
      <div class="score-item">
        <span>å¾—åˆ†:</span>
        <span id="currentScore">0</span>
      </div>
    </div>
  </div>

  <div class="game-area" id="gameArea">
    <div class="loading">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
  </div>
</div>

<script>
// å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
let currentUser = null;
try {
  const userStr = localStorage.getItem("currentUser");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
} catch (err) {
  console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š", err);
  currentUser = null;
}
let questions = [];
let currentQuestionIndex = 0;
let answers = [];
let score = 0;
let hasAnswered = false;

async function startGame() {
  if (!currentUser) {
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">è¯·å…ˆç™»å½•</div></div>';
    return;
  }

  try {
    const res = await fetch("/api/game-spell", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: currentUser.user_id, count: 10 })
    });

    if (!res.ok) {
      const data = await res.json();
      document.getElementById("gameArea").innerHTML = `<div class="result-screen"><div class="result-title">${data.error || "åŠ è½½å¤±è´¥"}</div></div>`;
      return;
    }

    const data = await res.json();
    questions = data.questions || [];
    
    if (questions.length === 0) {
      document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">è¯·å…ˆæ·»åŠ ä¸€äº›ç”Ÿå­—</div></div>';
      return;
    }

    answers = [];
    currentQuestionIndex = 0;
    score = 0;
    hasAnswered = false;
    
    document.getElementById("totalQuestions").textContent = questions.length;
    showQuestion();
  } catch (err) {
    console.error("åŠ è½½é¢˜ç›®å¤±è´¥ï¼š", err);
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div></div>';
  }
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    showResult();
    return;
  }

  const question = questions[currentQuestionIndex];
  const savedAnswer = answers[currentQuestionIndex]?.input_hanzi || "";
  hasAnswered = false;

  document.getElementById("currentQuestion").textContent = currentQuestionIndex + 1;
  
  let correctAnswerHtml = "";
  if (hasAnswered && savedAnswer) {
    const isCorrect = savedAnswer.trim() === question.correct_hanzi;
    correctAnswerHtml = `<div class="correct-answer">æ­£ç¡®ç­”æ¡ˆ: ${question.correct_hanzi}</div>`;
  }

  document.getElementById("gameArea").innerHTML = `
    <div class="question-container">
      <div class="question-title">è¯·æ ¹æ®æ‹¼éŸ³å†™å‡ºæ±‰å­—ï¼š</div>
      <div class="pinyin-display">${question.pinyin}</div>
      <div class="input-area">
        <div class="input-box ${hasAnswered ? (savedAnswer.trim() === question.correct_hanzi ? 'correct' : 'wrong') : ''}" id="inputBox">
          <input type="text" 
                 id="hanziInput" 
                 maxlength="1" 
                 value="${savedAnswer}"
                 placeholder="?"
                 oninput="handleInput()"
                 onkeypress="handleKeyPress(event)"
                 autocomplete="off"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false">
        </div>
        ${correctAnswerHtml}
      </div>
      <div class="controls">
        <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()" ${!savedAnswer ? 'disabled' : ''}>
          ${currentQuestionIndex === questions.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€é¢˜'}
        </button>
        <button class="btn btn-secondary" onclick="startGame()">é‡æ–°å¼€å§‹</button>
      </div>
    </div>
  `;

  // èšç„¦è¾“å…¥æ¡†
  const input = document.getElementById("hanziInput");
  if (input) {
    input.focus();
  }
}

function handleInput() {
  const input = document.getElementById("hanziInput");
  const submitBtn = document.getElementById("submitBtn");
  
  if (input && submitBtn) {
    const value = input.value.trim();
    submitBtn.disabled = !value;
    if (value) {
      submitBtn.style.opacity = "1";
    } else {
      submitBtn.style.opacity = "0.5";
    }
  }
}

function handleKeyPress(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn && !submitBtn.disabled) {
      submitAnswer();
    }
  }
}

function submitAnswer() {
  if (hasAnswered) {
    nextQuestion();
    return;
  }

  const input = document.getElementById("hanziInput");
  if (!input) return;

  const inputValue = input.value.trim();
  if (!inputValue) return;

  const question = questions[currentQuestionIndex];
  const isCorrect = inputValue === question.correct_hanzi;
  hasAnswered = true;

  if (!answers[currentQuestionIndex]) {
    answers[currentQuestionIndex] = {
      word_id: question.word_id,
      input_hanzi: inputValue
    };
  } else {
    answers[currentQuestionIndex].input_hanzi = inputValue;
  }

  // æ›´æ–°UI
  const inputBox = document.getElementById("inputBox");
  const submitBtn = document.getElementById("submitBtn");
  
  if (inputBox) {
    inputBox.classList.remove("correct", "wrong");
    inputBox.classList.add(isCorrect ? "correct" : "wrong");
  }

  if (input) {
    input.disabled = true;
  }

  // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
  const inputArea = document.querySelector(".input-area");
  if (inputArea && !isCorrect) {
    const correctDiv = document.createElement("div");
    correctDiv.className = "correct-answer";
    correctDiv.textContent = `æ­£ç¡®ç­”æ¡ˆ: ${question.correct_hanzi}`;
    inputArea.appendChild(correctDiv);
  }

  if (isCorrect) {
    score += 10;
    document.getElementById("currentScore").textContent = score;
  }

  if (submitBtn) {
    submitBtn.textContent = currentQuestionIndex === questions.length - 1 ? "å®Œæˆ" : "ä¸‹ä¸€é¢˜";
  }
}

function nextQuestion() {
  if (!hasAnswered) {
    submitAnswer();
    return;
  }
  
  currentQuestionIndex++;
  showQuestion();
}

async function showResult() {
  try {
    const res = await fetch("/api/game-spell/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.user_id,
        answers: answers
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      document.getElementById("gameArea").innerHTML = `<div class="result-screen"><div class="result-title">${data.error || "æäº¤å¤±è´¥"}</div></div>`;
      return;
    }

    const correctCount = data.correct_count || 0;
    const totalCount = data.total_count || 0;
    const finalScore = data.score || 0;
    const expEarned = data.exp_earned || 0;
    const isPerfect = correctCount === totalCount;
    const results = data.results || [];

    let celebration = "";
    if (isPerfect) {
      celebration = '<div class="celebration">ğŸ‰ å®Œç¾ï¼</div>';
    } else if (correctCount >= totalCount * 0.8) {
      celebration = '<div class="celebration">ğŸŒŸ å¾ˆæ£’ï¼</div>';
    } else if (correctCount >= totalCount * 0.6) {
      celebration = '<div class="celebration">ğŸ‘ ä¸é”™ï¼</div>';
    }

    // ç”Ÿæˆé”™è¯¯é¢˜ç›®è¯¦ç»†ä¿¡æ¯
    let wrongAnswersHtml = "";
    const wrongAnswers = results.filter(item => !item.correct);

    if (wrongAnswers.length > 0) {
      wrongAnswersHtml = `
        <div class="wrong-answers-section">
          <div class="wrong-answers-title">ğŸ“ é”™è¯¯é¢˜ç›®è¯¦æƒ…</div>
          ${wrongAnswers.map(item => `
            <div class="wrong-answer-item">
              <div class="wrong-answer-hanzi">${item.correct_hanzi}</div>
              <div class="wrong-answer-info">
                <div style="color: #999; margin-bottom: 4px;">æ‹¼éŸ³ï¼š${item.pinyin}</div>
                <div class="wrong-answer-selected">âŒ ä½ å†™çš„ï¼š${item.input_hanzi || 'æœªå¡«å†™'}</div>
                <div class="wrong-answer-correct">âœ“ æ­£ç¡®ç­”æ¡ˆï¼š${item.correct_hanzi}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    document.getElementById("gameArea").innerHTML = `
      <div class="result-screen">
        ${celebration}
        <div class="result-title">æ¸¸æˆç»“æŸ</div>
        <div class="result-score">${finalScore} åˆ†</div>
        <div class="result-details">
          <div>ç­”å¯¹: ${correctCount} / ${totalCount}</div>
          <div>è·å¾—ç»éªŒ: +${expEarned} EXP</div>
        </div>
        ${wrongAnswersHtml}
        <div class="controls">
          <button class="btn btn-primary" onclick="startGame()">å†æ¥ä¸€å±€</button>
          <button class="btn btn-secondary" onclick="if(window.parent && window.parent.switchPage){window.parent.switchPage('chinese');}else{window.location.href='chinese.html';}">è¿”å›ç”Ÿå­—æœ¬</button>
        </div>
      </div>
    `;

    // æ›´æ–°çˆ¶é¡µé¢çš„æ¸¸æˆæ•°æ®
    if (window.parent && typeof window.parent.updateGameStats === 'function') {
      window.parent.updateGameStats();
    }
  } catch (err) {
    console.error("æäº¤ç­”æ¡ˆå¤±è´¥ï¼š", err);
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•</div></div>';
  }
}

// é¡µé¢åŠ è½½æ—¶å¼€å§‹æ¸¸æˆ
if (currentUser) {
  startGame();
} else {
  document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">è¯·å…ˆç™»å½•</div></div>';
}
</script>
</body>
</html>
