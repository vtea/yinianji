<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>å¬éŸ³é€‰å­—æ¸¸æˆ - ç”Ÿå­—å­¦ä¹ </title>
  <style>
    /* åªä¿ç•™Tailwindæ— æ³•å®ç°çš„åŠ¨ç”»å’Œç‰¹æ®Šæ•ˆæœ */
    
    /* æ‹¼éŸ³æ˜¾ç¤ºå…‰æ•ˆåŠ¨ç”» */
    .pinyin-box::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
      animation: shimmer 3s infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 0.5; }
      50% { transform: translate(-30%, -30%) rotate(180deg); opacity: 0.8; }
    }

    /* æ’­æ”¾æŒ‰é’®å…‰æ™•æ•ˆæœ */
    .play-button::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: inherit;
      filter: blur(20px);
      opacity: 0.5;
      z-index: -1;
      pointer-events: none;
    }

    /* é€‰é¡¹æŒ‰é’®å…‰æ³½æ‰«è¿‡æ•ˆæœ */
    .option-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      transition: left 0.5s;
      pointer-events: none;
    }

    .option-button:hover::before {
      left: 100%;
    }

    /* é€‰é¡¹æŒ‰é’®çŠ¶æ€æ ·å¼ */
    .option-button.selected {
      @apply bg-gradient-to-r from-blue-500 to-blue-700 text-white;
      box-shadow: 0 8px 24px rgba(28, 176, 246, 0.6), 
                  0 0 0 4px rgba(28, 176, 246, 0.3),
                  inset 0 -4px 0 rgba(14, 138, 199, 0.4);
      transform: scale(1.05);
      border: 3px solid #1cb0f6;
      font-weight: 900;
    }

    .option-button.correct {
      @apply bg-gradient-to-b from-green-600 to-green-700 text-white;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.6), 
                  0 0 0 4px rgba(34, 197, 94, 0.3);
      border: 3px solid #22c55e;
      font-weight: 900;
      animation: correctPulse 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-button.wrong {
      @apply bg-gradient-to-b from-red-600 to-red-700 text-white;
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.6), 
                  0 0 0 4px rgba(239, 68, 68, 0.3);
      border: 3px solid #ef4444;
      font-weight: 900;
      animation: shake 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes correctPulse {
      0% { transform: scale(1); }
      25% { transform: scale(1.1) rotate(2deg); }
      50% { transform: scale(1.05) rotate(-2deg); }
      75% { transform: scale(1.08); }
      100% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) rotate(-2deg); }
      20%, 40%, 60%, 80% { transform: translateX(8px) rotate(2deg); }
    }

    .option-button.disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    /* å­—ä½“è®¾ç½® */
    body {
      font-family: "din-round", "Microsoft YaHei", sans-serif;
    }
  </style>
  <!-- Tailwind CSS - æ„å»ºåå¼•å…¥ -->
  <link href="/output.css?v=4.0.0" rel="stylesheet">
</head>
<body class="font-sans bg-gradient-to-br from-purple-500 to-purple-700 min-h-screen min-h-[100dvh] overflow-x-hidden pb-[env(safe-area-inset-bottom)]">
<div class="max-w-4xl mx-auto p-2 md:p-4 lg:p-6 grid grid-rows-[auto_1fr] gap-2 min-h-full">
  <div class="game-card p-3 md:p-4 flex justify-between items-center flex-wrap gap-2">
    <div class="text-lg md:text-xl lg:text-2xl font-extrabold text-green-500">ğŸ§ å¬éŸ³é€‰å­—</div>
    <div class="flex gap-2 md:gap-4 font-extrabold text-sm md:text-base">
      <div class="flex items-center gap-1">
        <span>é¢˜ç›®:</span>
        <span id="currentQuestion">0</span>/<span id="totalQuestions">0</span>
      </div>
      <div class="flex items-center gap-1">
        <span>å¾—åˆ†:</span>
        <span id="currentScore">0</span>
      </div>
    </div>
  </div>

  <div class="game-card p-6" id="gameArea">
    <div class="text-center text-lg font-extrabold text-gray-500">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
  </div>
</div>

<script>
// å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
let currentUser = null;
try {
  const userStr = localStorage.getItem("currentUser");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  }
} catch (err) {
  console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š", err);
  currentUser = null;
}
let questions = [];
let currentQuestionIndex = 0;
let answers = [];
let score = 0;
let hasAnswered = false;

function getVoiceSettingsSafe() {
  try {
    const raw = localStorage.getItem('voiceSettings');
    return raw ? JSON.parse(raw) : { rate: 0.8, voiceName: null };
  } catch (e) {
    return { rate: 0.8, voiceName: null };
  }
}

function speakText(text) {
  return new Promise((resolve) => {
    const content = (text || '').trim();
    if (!content) return resolve();

    const synth = window.speechSynthesis;
    if (!synth) {
      try {
        if (window.parent && typeof window.parent.speak === 'function') {
          window.parent.speak(content, 'chinese');
        }
      } catch (e) {}
      return resolve();
    }

    const settings = getVoiceSettingsSafe();
    const u = new SpeechSynthesisUtterance(content);
    u.lang = 'zh-CN';
    u.rate = settings.rate || 0.8;

    try {
      if (settings.voiceName && settings.voiceName !== 'default') {
        const voices = synth.getVoices();
        const v = voices.find(x => x.name === settings.voiceName);
        if (v) u.voice = v;
      }
    } catch (e) {}

    u.onend = () => resolve();
    u.onerror = () => resolve();

    try {
      synth.cancel();
      synth.speak(u);
    } catch (e) {
      resolve();
    }
  });
}

async function startGame() {
  if (!currentUser) {
    document.getElementById("gameArea").innerHTML = '<div class="game-card p-6 text-center"><div class="text-2xl font-extrabold text-gray-700">è¯·å…ˆç™»å½•</div></div>';
    return;
  }

  try {
    const res = await fetch("/api/game-listen", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: currentUser.user_id, count: 10 })
    });

    if (!res.ok) {
      const data = await res.json();
      document.getElementById("gameArea").innerHTML = `<div class="game-card p-6 text-center"><div class="text-2xl font-extrabold text-gray-700">${data.error || "åŠ è½½å¤±è´¥"}</div></div>`;
      return;
    }

    const data = await res.json();
    questions = data.questions || [];
    
    if (questions.length === 0) {
      document.getElementById("gameArea").innerHTML = '<div class="game-card p-6 text-center"><div class="text-2xl font-extrabold text-gray-700">è¯·å…ˆæ·»åŠ ä¸€äº›ç”Ÿå­—</div></div>';
      return;
    }

    answers = [];
    currentQuestionIndex = 0;
    score = 0;
    hasAnswered = false;
    
    document.getElementById("totalQuestions").textContent = questions.length;
    showQuestion();
  } catch (err) {
    console.error("åŠ è½½é¢˜ç›®å¤±è´¥ï¼š", err);
    document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div></div>';
  }
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    showResult();
    return;
  }

  const question = questions[currentQuestionIndex];
  const selectedId = answers[currentQuestionIndex]?.selected_hanzi_id || null;
  hasAnswered = false;

  document.getElementById("currentQuestion").textContent = currentQuestionIndex + 1;
  
  const optionsHtml = question.options.map((option, idx) => {
    const isSelected = option.id === selectedId;
    return `
      <button class="option-button ${isSelected ? 'selected' : ''} 
                  text-2xl md:text-3xl lg:text-4xl landscape:text-3xl
                  py-3 px-2 md:py-4 md:px-3 lg:py-5 lg:px-4 landscape:py-3 landscape:px-2
                  min-h-[60px] md:min-h-[70px] landscape:min-h-[65px]" 
              onclick="selectOption(${option.id})"
              data-id="${option.id}">
        ${option.hanzi}
      </button>
    `;
  }).join("");

  document.getElementById("gameArea").innerHTML = `
    <div class="game-card p-3 md:p-4 grid grid-rows-[auto_auto_1fr_auto] gap-2 min-h-0">
      <!-- æ ‡é¢˜ -->
      <div class="text-sm md:text-base font-extrabold text-center text-gray-700 mb-1 landscape:mb-0">
        è¯·å¬è¯»éŸ³ï¼Œé€‰æ‹©æ­£ç¡®çš„æ±‰å­—ï¼š
      </div>
      
      <!-- æ‹¼éŸ³å’Œæ’­æ”¾æŒ‰é’®ï¼ˆåŒä¸€è¡Œï¼‰ -->
      <div class="flex items-center justify-center gap-2 md:gap-3 my-2 landscape:my-1">
        <div class="pinyin-box flex-1 max-w-xs text-lg md:text-xl lg:text-2xl py-2 px-3 md:py-3 md:px-4 landscape:text-xl landscape:py-2 landscape:px-3">
          ${question.pinyin}
        </div>
        <button class="play-button w-11 h-11 md:w-12 md:h-12 lg:w-14 lg:h-14 text-lg md:text-xl lg:text-2xl landscape:w-12 landscape:h-12" 
                id="playBtn" onclick="playSound()">ğŸ”Š</button>
      </div>
      
      <!-- é€‰é¡¹ç½‘æ ¼ -->
      <div class="grid grid-cols-2 gap-2 md:gap-3 lg:gap-4 mt-2 landscape:mt-1">
        ${optionsHtml}
      </div>
      
      <!-- æ§åˆ¶æŒ‰é’®ï¼ˆåŒä¸€è¡Œï¼‰ -->
      <div class="flex gap-2 md:gap-3 mt-3 landscape:mt-2">
        <button class="btn-primary flex-1 text-sm md:text-base landscape:text-sm" 
                onclick="nextQuestion()" ${!selectedId ? 'disabled style="opacity:0.5"' : ''}>
          ${currentQuestionIndex === questions.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€é¢˜'}
        </button>
        <button class="btn-secondary flex-1 text-sm md:text-base landscape:text-sm" 
                onclick="startGame()">é‡æ–°å¼€å§‹</button>
      </div>
    </div>
  `;

  // è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡ - ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ¸²æŸ“
  requestAnimationFrame(() => {
    // ç¬¬ä¸€é¢˜æ—¶éœ€è¦æ›´é•¿çš„å»¶è¿Ÿï¼Œç¡®ä¿æµè§ˆå™¨å‡†å¤‡å¥½æ’­æ”¾éŸ³é¢‘
    const delay = currentQuestionIndex === 0 ? 800 : 500;
    setTimeout(() => playSound(), delay);
  });
}

async function playSound() {
  const question = questions[currentQuestionIndex];
  if (!question) return;

  const btn = document.getElementById("playBtn");
  if (btn) {
    btn.classList.add("playing");
    btn.disabled = true;
  }

  await speakText(`${question.hanzi}ï¼Œæ‹¼éŸ³ï¼š${question.pinyin}`);

  if (btn) {
    btn.classList.remove("playing");
    btn.disabled = false;
  }
}

function selectOption(hanziId) {
  if (hasAnswered) return;

  const question = questions[currentQuestionIndex];
  const isCorrect = question.word_id === hanziId;
  hasAnswered = true;

  if (!answers[currentQuestionIndex]) {
    answers[currentQuestionIndex] = {
      word_id: question.word_id,
      selected_hanzi_id: hanziId
    };
  } else {
    answers[currentQuestionIndex].selected_hanzi_id = hanziId;
  }

  // å…ˆæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
  document.querySelectorAll(".option-button").forEach(btn => {
    btn.classList.remove("selected");
    const btnId = parseInt(btn.dataset.id);
    if (btnId === hanziId) {
      btn.classList.add("selected");
    }
  });

  // å»¶è¿Ÿæ˜¾ç¤ºæ­£ç¡®/é”™è¯¯ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰ä¸­çŠ¶æ€
  setTimeout(() => {
    document.querySelectorAll(".option-button").forEach(btn => {
      btn.classList.remove("selected", "correct", "wrong", "disabled");
      const btnId = parseInt(btn.dataset.id);
      
      if (btnId === hanziId) {
        if (isCorrect) {
          btn.classList.add("correct");
          score += 10;
          document.getElementById("currentScore").textContent = score;
        } else {
          btn.classList.add("wrong");
        }
      }
      
      if (btnId === question.word_id && isCorrect === false) {
        btn.classList.add("correct");
      }
      
      btn.classList.add("disabled");
    });
  }, 300);

  // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
  const nextBtn = document.querySelector(".btn-primary");
  if (nextBtn) {
    nextBtn.disabled = false;
    nextBtn.style.opacity = "1";
  }
}

function nextQuestion() {
  if (!answers[currentQuestionIndex]?.selected_hanzi_id) {
    return;
  }
  
  currentQuestionIndex++;
  showQuestion();
}

async function showResult() {
  try {
    const res = await fetch("/api/game-listen/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.user_id,
        answers: answers
      })
    });

    const data = await res.json();
    
    if (!res.ok) {
      document.getElementById("gameArea").innerHTML = `<div class="result-screen"><div class="result-title">${data.error || "æäº¤å¤±è´¥"}</div></div>`;
      return;
    }

    const correctCount = data.correct_count || 0;
    const totalCount = data.total_count || 0;
    const finalScore = data.score || 0;
    const expEarned = data.exp_earned || 0;
    const maxConsecutive = data.max_consecutive || 0;
    const isPerfect = correctCount === totalCount;
    const results = data.results || [];

    let celebration = "";
    if (isPerfect) {
      celebration = '<div class="text-5xl md:text-6xl lg:text-7xl my-4 landscape:text-6xl animate-bounce">ğŸ‰ å®Œç¾ï¼</div>';
    } else if (correctCount >= totalCount * 0.8) {
      celebration = '<div class="text-5xl md:text-6xl lg:text-7xl my-4 landscape:text-6xl animate-bounce">ğŸŒŸ å¾ˆæ£’ï¼</div>';
    } else if (correctCount >= totalCount * 0.6) {
      celebration = '<div class="text-5xl md:text-6xl lg:text-7xl my-4 landscape:text-6xl animate-bounce">ğŸ‘ ä¸é”™ï¼</div>';
    }

    let consecutiveInfo = "";
    if (maxConsecutive >= 3) {
      consecutiveInfo = `<div class="text-yellow-500 font-extrabold mt-2">è¿ç»­ç­”å¯¹ ${maxConsecutive} é¢˜ï¼</div>`;
    }

    // ç”Ÿæˆé”™è¯¯é¢˜ç›®è¯¦ç»†ä¿¡æ¯
    let wrongAnswersHtml = "";
    const wrongAnswers = results.filter((item, index) => {
      if (!item.correct) {
        // æ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„æ±‰å­—
        const selectedAnswer = answers[index];
        const selectedOption = questions[index]?.options?.find(opt => opt.id === selectedAnswer?.selected_hanzi_id);
        item.selected_hanzi = selectedOption ? selectedOption.hanzi : 'æœªé€‰æ‹©';
        return true;
      }
      return false;
    });

    if (wrongAnswers.length > 0) {
      wrongAnswersHtml = `
        <div class="bg-yellow-50 rounded-xl p-3 md:p-4 my-4 text-left landscape:my-3">
          <div class="text-base md:text-lg font-extrabold text-orange-500 mb-2 text-center landscape:text-base">ğŸ“ é”™è¯¯é¢˜ç›®è¯¦æƒ…</div>
          ${wrongAnswers.map(item => `
            <div class="bg-white rounded-lg p-2 md:p-3 mb-2 border-2 border-yellow-400 landscape:p-2">
              <div class="text-xl md:text-2xl font-extrabold text-blue-500 mb-1 text-center landscape:text-xl">${item.correct_hanzi}</div>
              <div class="text-xs md:text-sm text-gray-600 space-y-1 landscape:text-xs">
                <div class="text-gray-500">æ‹¼éŸ³ï¼š${item.pinyin}</div>
                <div class="text-red-500">âŒ ä½ é€‰çš„ï¼š${item.selected_hanzi}</div>
                <div class="text-green-500">âœ“ æ­£ç¡®ç­”æ¡ˆï¼š${item.correct_hanzi}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    document.getElementById("gameArea").innerHTML = `
      <div class="game-card p-4 md:p-6 text-center max-w-2xl mx-auto">
        ${celebration}
        <div class="text-xl md:text-2xl lg:text-3xl font-extrabold text-gray-700 mb-2 landscape:text-2xl">æ¸¸æˆç»“æŸ</div>
        <div class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-green-500 my-4 landscape:text-4xl">${finalScore} åˆ†</div>
        <div class="text-base md:text-lg text-gray-600 mb-4 space-y-1 landscape:text-base">
          <div>ç­”å¯¹: ${correctCount} / ${totalCount}</div>
          ${consecutiveInfo}
          <div>è·å¾—ç»éªŒ: +${expEarned} EXP</div>
        </div>
        ${wrongAnswersHtml}
        <div class="flex gap-2 md:gap-3 mt-4 landscape:mt-3">
          <button class="btn-primary flex-1 text-sm md:text-base landscape:text-sm" onclick="startGame()">å†æ¥ä¸€å±€</button>
          <button class="btn-secondary flex-1 text-sm md:text-base landscape:text-sm" onclick="if(window.parent && window.parent.switchPage){window.parent.switchPage('chinese');}else{window.location.href='chinese.html';}">è¿”å›ç”Ÿå­—æœ¬</button>
        </div>
      </div>
    `;

    // æ›´æ–°çˆ¶é¡µé¢çš„æ¸¸æˆæ•°æ®
    if (window.parent && typeof window.parent.updateGameStats === 'function') {
      window.parent.updateGameStats();
    }
  } catch (err) {
    console.error("æäº¤ç­”æ¡ˆå¤±è´¥ï¼š", err);
    document.getElementById("gameArea").innerHTML = '<div class="game-card p-6 text-center"><div class="text-2xl font-extrabold text-gray-700">æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•</div></div>';
  }
}

// é¡µé¢åŠ è½½æ—¶å¼€å§‹æ¸¸æˆ
if (currentUser) {
  startGame();
} else {
  document.getElementById("gameArea").innerHTML = '<div class="result-screen"><div class="result-title">è¯·å…ˆç™»å½•</div></div>';
}
</script>
</body>
</html>
